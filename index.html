<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª × ×™×”×•×œ ××•×¡×š</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase v9 Compatible Mode -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="loader mx-auto mb-4"></div>
            <p class="text-gray-600">×˜×•×¢×Ÿ ××¢×¨×›×ª...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="hidden fixed inset-0 bg-blue-50 z-40 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
            <h1 class="text-2xl font-bold text-center mb-6">××¢×¨×›×ª × ×™×”×•×œ ××•×¡×š</h1>
            
            <div id="errorMsg" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
            <div id="successMsg" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4"></div>
            
            <form id="loginForm">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">××™××™×™×œ</label>
                    <input type="email" id="email" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 mb-2">×¡×™×¡××”</label>
                    <input type="password" id="password" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                </div>
                
                <button type="submit" id="authBtn" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                    ×”×ª×—×‘×¨
                </button>
            </form>
            
            <p class="text-center mt-4">
                <a href="#" id="toggleAuth" class="text-blue-600 hover:underline">××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ? ×”×™×¨×©×</a>
            </p>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-bold">××¢×¨×›×ª × ×™×”×•×œ ××•×¡×š</h1>
                <button onclick="signOut()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    ×™×¦×™××”
                </button>
            </div>
            
            <div class="flex gap-4 mb-4">
                <button onclick="openCarModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    + ×”×•×¡×£ ×¨×›×‘
                </button>
                <button onclick="exportCSV()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                    ×™×™×¦× × ×ª×•× ×™×
                </button>
            </div>
            
            <input type="text" id="searchBox" placeholder="×—×™×¤×•×©..." onkeyup="searchCars()" 
                   class="w-full px-3 py-2 border rounded-lg">
        </div>

        <!-- Cars Grid -->
        <div id="carsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        
        <!-- Empty State -->
        <div id="emptyState" class="text-center py-12 hidden">
            <p class="text-gray-500 text-xl">××™×Ÿ ×¨×›×‘×™× ×‘××¢×¨×›×ª</p>
            <button onclick="openCarModal()" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                ×”×•×¡×£ ×¨×›×‘ ×¨××©×•×Ÿ
            </button>
        </div>
    </div>

    <!-- Car Modal -->
    <div id="carModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-lg p-6 max-w-md w-full my-8">
            <h2 id="modalTitle" class="text-xl font-bold mb-4">×”×•×¡×£ ×¨×›×‘</h2>
            
            <form id="carForm">
                <div class="mb-3">
                    <label class="block text-gray-700 mb-1">××¡×¤×¨ ×¨×™×©×•×™ *</label>
                    <input type="text" id="plateNumber" required class="w-full px-3 py-2 border rounded">
                </div>
                
                <div class="mb-3">
                    <label class="block text-gray-700 mb-1">×©× ×”×‘×¢×œ×™×</label>
                    <input type="text" id="ownerName" class="w-full px-3 py-2 border rounded">
                </div>
                
                <div class="mb-3">
                    <label class="block text-gray-700 mb-1">×˜×œ×¤×•×Ÿ</label>
                    <input type="text" id="phone" class="w-full px-3 py-2 border rounded">
                </div>
                
                <div class="mb-3">
                    <label class="block text-gray-700 mb-1">×¡×•×’ ×¨×›×‘</label>
                    <input type="text" id="carType" class="w-full px-3 py-2 border rounded">
                </div>
                
                <div class="mb-3">
                    <label class="block text-gray-700 mb-1">×“×’×</label>
                    <input type="text" id="model" class="w-full px-3 py-2 border rounded">
                </div>
                
                <div class="mb-3">
                    <label class="block text-gray-700 mb-1">×©× ×”</label>
                    <input type="text" id="year" class="w-full px-3 py-2 border rounded">
                </div>
                
                <div class="mb-3">
                    <label class="block text-gray-700 mb-1">×ª××•× ×”</label>
                    <input type="file" id="carImage" accept="image/*" class="w-full">
                    <div id="imagePreview" class="mt-2"></div>
                    <p class="text-xs text-green-600 mt-1">âœ“ ×“×—×™×¡×” ××•×˜×•××˜×™×ª</p>
                </div>
                
                <div class="flex gap-2">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        ×©××•×¨
                    </button>
                    <button type="button" onclick="closeCarModal()" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">
                        ×‘×™×˜×•×œ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Maintenance Modal -->
    <div id="maintenanceModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full my-8 max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white pb-2 mb-4 border-b">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold">×”×•×¡×£ ×˜×™×¤×•×œ</h2>
                    <button type="button" onclick="closeMaintenanceModal()" class="text-gray-500 hover:text-gray-700 text-3xl leading-none">&times;</button>
                </div>
            </div>
            
            <form id="maintenanceForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-3">
                        <label class="block text-gray-700 mb-1">×ª××¨×™×š ×›× ×™×¡×”</label>
                        <input type="date" id="entryDate" class="w-full px-3 py-2 border rounded">
                    </div>
                    
                    <div class="mb-3">
                        <label class="block text-gray-700 mb-1">×ª××¨×™×š ×™×¦×™××”</label>
                        <input type="date" id="exitDate" class="w-full px-3 py-2 border rounded">
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="block text-gray-700 mb-1">×ª×™××•×¨ ×”×¢×‘×•×“×”</label>
                    <textarea id="workDescription" rows="3" class="w-full px-3 py-2 border rounded" placeholder="××” × ×¢×©×” ×‘×¨×›×‘? (××•×¤×¦×™×•× ×œ×™)"></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="block text-gray-700 mb-1">×—×œ×§×™ ×—×™×œ×•×£</label>
                    <textarea id="parts" rows="2" class="w-full px-3 py-2 border rounded" placeholder="×¨×©×™××ª ×—×œ×§×™× (××•×¤×¦×™×•× ×œ×™)"></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="block text-gray-700 mb-1">×¢×œ×•×ª (â‚ª)</label>
                    <input type="number" id="totalCost" class="w-full px-3 py-2 border rounded" placeholder="0">
                </div>
                
                <div class="mb-3">
                    <label class="block text-gray-700 mb-1">×”×¢×¨×•×ª</label>
                    <textarea id="notes" rows="2" class="w-full px-3 py-2 border rounded" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª (××•×¤×¦×™×•× ×œ×™)"></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="block text-gray-700 mb-1">×ª××•× ×•×ª</label>
                    <input type="file" id="maintenanceImages" accept="image/*" multiple class="w-full">
                    <div id="maintenanceImagesPreview" class="mt-2 grid grid-cols-3 gap-2"></div>
                    <p class="text-xs text-gray-500 mt-1">× ×™×ª×Ÿ ×œ×‘×—×•×¨ ××¡×¤×¨ ×ª××•× ×•×ª</p>
                </div>
                
                <div class="flex gap-2 mt-4">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        ×©××•×¨ ×˜×™×¤×•×œ
                    </button>
                    <button type="button" onclick="closeMaintenanceModal()" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">
                        ×‘×™×˜×•×œ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Car Details Modal -->
    <div id="carDetailsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b p-6 flex justify-between items-center">
                <h2 class="text-2xl font-bold" id="detailsPlateNumber"></h2>
                <button onclick="closeCarDetailsModal()" class="text-gray-500 hover:text-gray-700 text-3xl leading-none">&times;</button>
            </div>
            
            <div class="p-6">
                <div id="carDetailsContent"></div>
                
                <div class="mt-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">×”×™×¡×˜×•×¨×™×™×ª ×˜×™×¤×•×œ×™×</h3>
                        <button onclick="openMaintenanceModal()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                            + ×”×•×¡×£ ×˜×™×¤×•×œ
                        </button>
                    </div>
                    
                    <div id="maintenanceHistory" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCdSRfJCoU6xwDych3l_3K_hBZBHOi9jVg",
            authDomain: "garage-17263.firebaseapp.com",
            projectId: "garage-17263",
            storageBucket: "garage-17263.firebasestorage.app",
            messagingSenderId: "332265903935",
            appId: "1:332265903935:web:237c0787a161fd36a7a58a",
            measurementId: "G-KLLCPECCDQ"
        };

        // Initialize Firebase
        let app, db, auth;
        let currentUser = null;
        let cars = [];
        let editingCarId = null;
        let currentCarId = null;
        let editingMaintenanceId = null;
        let isRegisterMode = false;
        let maintenanceImages = [];

        try {
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            console.log('Firebase initialized with maintenance system!');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            document.getElementById('loadingScreen').innerHTML = 
                '<div class="text-center"><p class="text-red-600">×©×’×™××” ×‘×˜×¢×™× ×ª ×”××¢×¨×›×ª</p></div>';
        }

        // Compress Image Function
        async function compressImage(file, maxSizeKB = 700) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        const maxDimension = 1200;
                        if (width > height && width > maxDimension) {
                            height = (height * maxDimension) / width;
                            width = maxDimension;
                        } else if (height > maxDimension) {
                            width = (width * maxDimension) / height;
                            height = maxDimension;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        let quality = 0.8;
                        let compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        
                        while (compressedDataUrl.length > maxSizeKB * 1024 * 1.37 && quality > 0.1) {
                            quality -= 0.1;
                            compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        }
                        
                        resolve(compressedDataUrl);
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        // Calculate Total Cost
        function calculateTotalCost() {
            const partsCost = parseFloat(document.getElementById('partsCost').value) || 0;
            const laborCost = parseFloat(document.getElementById('laborCost').value) || 0;
            const otherCost = parseFloat(document.getElementById('otherCost').value) || 0;
            const total = partsCost + laborCost + otherCost;
            document.getElementById('totalCostDisplay').textContent = total.toFixed(2);
            return total;
        }

        // Auth State Observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                loadCars();
            } else {
                currentUser = null;
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
            
            document.getElementById('loadingScreen').classList.add('hidden');
        });

        // Toggle Auth Mode
        document.getElementById('toggleAuth').addEventListener('click', (e) => {
            e.preventDefault();
            isRegisterMode = !isRegisterMode;
            const authBtn = document.getElementById('authBtn');
            const toggleLink = document.getElementById('toggleAuth');
            
            if (isRegisterMode) {
                authBtn.textContent = '×”×™×¨×©×';
                toggleLink.textContent = '×™×© ×œ×š ×—×©×‘×•×Ÿ? ×”×ª×—×‘×¨';
            } else {
                authBtn.textContent = '×”×ª×—×‘×¨';
                toggleLink.textContent = '××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ? ×”×™×¨×©×';
            }
        });

        // Login/Register Form
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const authBtn = document.getElementById('authBtn');
            
            authBtn.disabled = true;
            authBtn.textContent = '××¢×‘×“...';
            
            try {
                if (isRegisterMode) {
                    await auth.createUserWithEmailAndPassword(email, password);
                    showMessage('×”×—×©×‘×•×Ÿ × ×•×¦×¨ ×‘×”×¦×œ×—×”!', 'success');
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                    showMessage('×”×ª×—×‘×¨×ª ×‘×”×¦×œ×—×”!', 'success');
                }
            } catch (error) {
                console.error('Auth error:', error);
                let message = '×©×’×™××”';
                
                switch(error.code) {
                    case 'auth/user-not-found':
                        message = '×”××©×ª××© ×œ× ×§×™×™×';
                        break;
                    case 'auth/wrong-password':
                        message = '×¡×™×¡××” ×©×’×•×™×”';
                        break;
                    case 'auth/email-already-in-use':
                        message = '×”××™××™×™×œ ×›×‘×¨ ×‘×©×™××•×©';
                        break;
                    case 'auth/weak-password':
                        message = '×”×¡×™×¡××” ×—×œ×©×” ××“×™';
                        break;
                    case 'auth/invalid-email':
                        message = '××™××™×™×œ ×œ× ×ª×§×™×Ÿ';
                        break;
                }
                
                showMessage(message, 'error');
            } finally {
                authBtn.disabled = false;
                authBtn.textContent = isRegisterMode ? '×”×™×¨×©×' : '×”×ª×—×‘×¨';
            }
        });

        // Load Cars
        async function loadCars() {
            try {
                const snapshot = await db.collection('cars')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                cars = [];
                snapshot.forEach(doc => {
                    cars.push({ id: doc.id, ...doc.data() });
                });
                
                displayCars();
            } catch (error) {
                console.error('Error loading cars:', error);
            }
        }

        // Display Cars
        function displayCars() {
            const grid = document.getElementById('carsGrid');
            const emptyState = document.getElementById('emptyState');
            
            if (cars.length === 0) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            grid.innerHTML = cars.map(car => `
                <div class="bg-white rounded-lg shadow p-4 car-card" data-search="${car.plateNumber} ${car.ownerName || ''}">
                    ${car.imageUrl ? 
                        `<img src="${car.imageUrl}" class="w-full h-40 object-cover rounded mb-3 cursor-pointer" onclick="viewCarDetails('${car.id}')">` : 
                        `<div class="w-full h-40 bg-gray-200 rounded mb-3 flex items-center justify-center text-gray-400 cursor-pointer" onclick="viewCarDetails('${car.id}')">××™×Ÿ ×ª××•× ×”</div>`
                    }
                    <h3 class="font-bold text-lg cursor-pointer hover:text-blue-600" onclick="viewCarDetails('${car.id}')">${car.plateNumber}</h3>
                    ${car.ownerName ? `<p class="text-gray-600">${car.ownerName}</p>` : ''}
                    ${car.phone ? `<p class="text-sm">ğŸ“ ${car.phone}</p>` : ''}
                    ${car.carType ? `<p class="text-sm">ğŸš— ${car.carType}</p>` : ''}
                    ${car.model ? `<p class="text-sm">ğŸ“‹ ${car.model}</p>` : ''}
                    ${car.year ? `<p class="text-sm">ğŸ“… ${car.year}</p>` : ''}
                    
                    <div class="mt-3 flex gap-2 flex-wrap">
                        <button onclick="viewCarDetails('${car.id}')" class="text-green-600 hover:underline text-sm">ğŸ“‹ ×¤×¨×˜×™×</button>
                        <button onclick="editCar('${car.id}')" class="text-blue-600 hover:underline text-sm">×¢×¨×™×›×”</button>
                        <button onclick="deleteCar('${car.id}')" class="text-red-600 hover:underline text-sm">××—×™×§×”</button>
                    </div>
                </div>
            `).join('');
        }

        // View Car Details
        async function viewCarDetails(carId) {
            currentCarId = carId;
            const car = cars.find(c => c.id === carId);
            if (!car) return;
            
            // Display car details
            document.getElementById('detailsPlateNumber').textContent = car.plateNumber;
            
            // WhatsApp and Call buttons
            const phoneButtons = car.phone ? `
                <div class="mb-6 flex flex-wrap gap-2">
                    <a href="tel:${car.phone}" class="flex-1 min-w-[200px] bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 text-center font-bold">
                        ğŸ“ ×”×ª×§×©×¨ ×œ${car.ownerName || '×‘×¢×œ×™×'}
                    </a>
                    <a href="https://wa.me/972${car.phone.replace(/^0/, '')}?text=${encodeURIComponent('×©×œ×•× ' + (car.ownerName || '') + ', ×¨×›×‘×š ' + car.plateNumber + ' × ×›× ×¡ ×œ×˜×™×¤×•×œ ×‘××•×¡×š. × ×¢×“×›×Ÿ ××•×ª×š ×‘×”××©×š.')}" 
                       target="_blank" 
                       class="flex-1 min-w-[200px] bg-blue-500 text-white px-4 py-3 rounded-lg hover:bg-blue-600 text-center font-bold">
                        ğŸ’¬ × ×›× ×¡ ×œ×˜×™×¤×•×œ
                    </a>
                    <a href="https://wa.me/972${car.phone.replace(/^0/, '')}?text=${encodeURIComponent('×©×œ×•× ' + (car.ownerName || '') + ', ×¨×›×‘×š ' + car.plateNumber + ' ××•×›×Ÿ ×•××—×›×” ×œ××™×¡×•×£. × ×™×ª×Ÿ ×œ×‘×•× ×œ×§×—×ª ××ª ×”×¨×›×‘.')}" 
                       target="_blank" 
                       class="flex-1 min-w-[200px] bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600 text-center font-bold">
                        âœ… ××•×›×Ÿ ×œ××™×¡×•×£
                    </a>
                    <a href="https://wa.me/972${car.phone.replace(/^0/, '')}?text=${encodeURIComponent('×©×œ×•× ' + (car.ownerName || '') + ', ×¨×›×‘×š ' + car.plateNumber + ' × ××¡×¨ ×‘×”×¦×œ×—×”. ×ª×•×“×” ×©×‘×—×¨×ª ×‘×©×™×¨×•×ª×™× ×•!')}" 
                       target="_blank" 
                       class="flex-1 min-w-[200px] bg-purple-500 text-white px-4 py-3 rounded-lg hover:bg-purple-600 text-center font-bold">
                        ğŸ‰ × ××¡×¨ ×‘×”×¦×œ×—×”
                    </a>
                </div>
            ` : '<div class="mb-6 p-4 bg-yellow-100 border border-yellow-400 text-yellow-800 rounded">××™×Ÿ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ - ×× × ×”×•×¡×£ ××¡×¤×¨ ×›×“×™ ×œ×”×©×ª××© ×‘×ª×›×•× ×•×ª ×”×ª×§×©×•×¨×ª</div>';
            
            document.getElementById('carDetailsContent').innerHTML = `
                ${phoneButtons}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    ${car.imageUrl ? `
                        <div class="col-span-2">
                            <img src="${car.imageUrl}" class="w-full max-h-64 object-contain rounded">
                        </div>
                    ` : ''}
                    ${car.ownerName ? `<div><span class="font-bold">×©× ×”×‘×¢×œ×™×:</span> ${car.ownerName}</div>` : ''}
                    ${car.phone ? `<div><span class="font-bold">×˜×œ×¤×•×Ÿ:</span> ${car.phone}</div>` : ''}
                    ${car.carType ? `<div><span class="font-bold">×¡×•×’ ×¨×›×‘:</span> ${car.carType}</div>` : ''}
                    ${car.model ? `<div><span class="font-bold">×“×’×:</span> ${car.model}</div>` : ''}
                    ${car.year ? `<div><span class="font-bold">×©× ×”:</span> ${car.year}</div>` : ''}
                </div>
            `;
            
            // Load maintenance history
            await loadMaintenanceHistory(carId);
            
            document.getElementById('carDetailsModal').classList.remove('hidden');
        }

        // Load Maintenance History
        async function loadMaintenanceHistory(carId) {
            try {
                const snapshot = await db.collection('maintenance')
                    .where('carId', '==', carId)
                    .get();
                
                const maintenanceList = [];
                snapshot.forEach(doc => {
                    maintenanceList.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by createdAt in JavaScript (no Firestore index needed)
                maintenanceList.sort((a, b) => {
                    const dateA = a.createdAt?.toMillis() || 0;
                    const dateB = b.createdAt?.toMillis() || 0;
                    return dateB - dateA; // Newest first
                });
                
                const historyDiv = document.getElementById('maintenanceHistory');
                
                if (maintenanceList.length === 0) {
                    historyDiv.innerHTML = '<p class="text-gray-500 text-center py-4">××™×Ÿ ×˜×™×¤×•×œ×™× ×¢×“×™×™×Ÿ</p>';
                    return;
                }
                
                historyDiv.innerHTML = maintenanceList.map(m => {
                    return `
                        <div class="border rounded-lg p-4 bg-gray-50">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    ${m.entryDate || m.exitDate ? `
                                        <div class="text-sm mb-2">
                                            ${m.entryDate ? `<span>ğŸ“… ×›× ×™×¡×”: ${m.entryDate}</span>` : ''}
                                            ${m.exitDate ? `<span class="mr-4">ğŸ“¤ ×™×¦×™××”: ${m.exitDate}</span>` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="editMaintenance('${m.id}')" class="text-blue-600 hover:underline text-sm">×¢×¨×™×›×”</button>
                                    <button onclick="deleteMaintenance('${m.id}')" class="text-red-600 hover:underline text-sm">××—×™×§×”</button>
                                </div>
                            </div>
                            
                            ${m.workDescription ? `<p class="mb-2"><strong>×¢×‘×•×“×”:</strong> ${m.workDescription}</p>` : ''}
                            ${m.parts ? `<p class="mb-2"><strong>×—×œ×§×™×:</strong> ${m.parts}</p>` : ''}
                            
                            ${m.totalCost > 0 ? `
                                <div class="text-lg font-bold text-green-700 mb-2">
                                    ğŸ’° ${m.totalCost.toFixed(2)} â‚ª
                                </div>
                            ` : ''}
                            
                            ${m.notes ? `<p class="text-sm text-gray-600 mb-2"><strong>×”×¢×¨×•×ª:</strong> ${m.notes}</p>` : ''}
                            
                            ${m.images && m.images.length > 0 ? `
                                <div class="grid grid-cols-3 gap-2 mt-2">
                                    ${m.images.map(img => `<img src="${img}" class="w-full h-24 object-cover rounded cursor-pointer" onclick="window.open('${img}')">`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading maintenance:', error);
            }
        }

        // Close Car Details Modal
        function closeCarDetailsModal() {
            document.getElementById('carDetailsModal').classList.add('hidden');
            currentCarId = null;
        }

        // Open Car Modal
        function openCarModal() {
            editingCarId = null;
            document.getElementById('modalTitle').textContent = '×”×•×¡×£ ×¨×›×‘';
            document.getElementById('carForm').reset();
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('carModal').classList.remove('hidden');
        }

        // Close Car Modal
        function closeCarModal() {
            document.getElementById('carModal').classList.add('hidden');
            editingCarId = null;
        }

        // Edit Car
        function editCar(carId) {
            const car = cars.find(c => c.id === carId);
            if (!car) return;
            
            editingCarId = carId;
            document.getElementById('modalTitle').textContent = '×¢×¨×•×š ×¨×›×‘';
            document.getElementById('plateNumber').value = car.plateNumber || '';
            document.getElementById('ownerName').value = car.ownerName || '';
            document.getElementById('phone').value = car.phone || '';
            document.getElementById('carType').value = car.carType || '';
            document.getElementById('model').value = car.model || '';
            document.getElementById('year').value = car.year || '';
            
            if (car.imageUrl) {
                document.getElementById('imagePreview').innerHTML = 
                    `<img src="${car.imageUrl}" class="w-32 h-32 object-cover rounded">`;
            }
            
            document.getElementById('carModal').classList.remove('hidden');
        }

        // Car Form Submit
        document.getElementById('carForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = '×©×•××¨...';
            
            try {
                const carData = {
                    plateNumber: document.getElementById('plateNumber').value.trim(),
                    ownerName: document.getElementById('ownerName').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    carType: document.getElementById('carType').value.trim(),
                    model: document.getElementById('model').value.trim(),
                    year: document.getElementById('year').value.trim(),
                    userId: currentUser.uid,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const imageFile = document.getElementById('carImage').files[0];
                if (imageFile) {
                    try {
                        submitBtn.textContent = '×“×•×—×¡ ×ª××•× ×”...';
                        const compressedImage = await compressImage(imageFile, 700);
                        carData.imageUrl = compressedImage;
                        submitBtn.textContent = '×©×•××¨ × ×ª×•× ×™×...';
                    } catch (imageError) {
                        console.error('Image compression error:', imageError);
                        alert('×©×’×™××” ×‘×¢×™×‘×•×“ ×”×ª××•× ×”. ×× × × ×¡×” ×©×•×‘.');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                        return;
                    }
                } else if (editingCarId) {
                    const existingCar = cars.find(c => c.id === editingCarId);
                    if (existingCar && existingCar.imageUrl) {
                        carData.imageUrl = existingCar.imageUrl;
                    }
                }
                
                if (editingCarId) {
                    await db.collection('cars').doc(editingCarId).update(carData);
                    alert('×”×¨×›×‘ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!');
                } else {
                    carData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('cars').add(carData);
                    alert('×”×¨×›×‘ × ×•×¡×£ ×‘×”×¦×œ×—×”!');
                }
                
                document.getElementById('carForm').reset();
                document.getElementById('imagePreview').innerHTML = '';
                closeCarModal();
                await loadCars();
                
            } catch (error) {
                console.error('Error saving car:', error);
                alert('×©×’×™××”: ' + (error.message || '×œ× × ×™×ª×Ÿ ×œ×©××•×¨ ××ª ×”× ×ª×•× ×™×'));
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // Delete Car
        async function deleteCar(carId) {
            if (!confirm('×”×× ×œ××—×•×§ ××ª ×”×¨×›×‘? ×’× ×›×œ ×”×˜×™×¤×•×œ×™× ×™×™××—×§×•.')) return;
            
            try {
                // Delete all maintenance records
                const maintenanceSnapshot = await db.collection('maintenance')
                    .where('carId', '==', carId)
                    .get();
                
                const deletePromises = [];
                maintenanceSnapshot.forEach(doc => {
                    deletePromises.push(doc.ref.delete());
                });
                await Promise.all(deletePromises);
                
                // Delete car
                await db.collection('cars').doc(carId).delete();
                alert('×”×¨×›×‘ × ××—×§ ×‘×”×¦×œ×—×”');
                await loadCars();
            } catch (error) {
                console.error('Error deleting car:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×”×¨×›×‘');
            }
        }

        // Open Maintenance Modal
        function openMaintenanceModal() {
            if (!currentCarId) {
                alert('×× × ×‘×—×¨ ×¨×›×‘ ×ª×—×™×œ×”');
                return;
            }
            
            editingMaintenanceId = null;
            maintenanceImages = [];
            document.getElementById('maintenanceForm').reset();
            document.getElementById('maintenanceImagesPreview').innerHTML = '';
            document.getElementById('maintenanceModal').classList.remove('hidden');
        }

        // Close Maintenance Modal
        function closeMaintenanceModal() {
            document.getElementById('maintenanceModal').classList.add('hidden');
            editingMaintenanceId = null;
            maintenanceImages = [];
        }

        // Edit Maintenance
        async function editMaintenance(maintenanceId) {
            try {
                const doc = await db.collection('maintenance').doc(maintenanceId).get();
                if (!doc.exists) return;
                
                const m = doc.data();
                editingMaintenanceId = maintenanceId;
                
                document.getElementById('entryDate').value = m.entryDate || '';
                document.getElementById('exitDate').value = m.exitDate || '';
                document.getElementById('workDescription').value = m.workDescription || '';
                document.getElementById('parts').value = m.parts || '';
                document.getElementById('totalCost').value = m.totalCost || '';
                document.getElementById('notes').value = m.notes || '';
                
                maintenanceImages = m.images || [];
                
                if (maintenanceImages.length > 0) {
                    document.getElementById('maintenanceImagesPreview').innerHTML = 
                        maintenanceImages.map((img, i) => `
                            <div class="relative">
                                <img src="${img}" class="w-full h-24 object-cover rounded">
                                <button type="button" onclick="removeMaintenanceImage(${i})" class="absolute top-0 right-0 bg-red-500 text-white rounded-full w-6 h-6 text-xs">Ã—</button>
                            </div>
                        `).join('');
                }
                
                document.getElementById('maintenanceModal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading maintenance:', error);
            }
        }

        // Delete Maintenance
        async function deleteMaintenance(maintenanceId) {
            if (!confirm('×”×× ×œ××—×•×§ ××ª ×”×˜×™×¤×•×œ?')) return;
            
            try {
                await db.collection('maintenance').doc(maintenanceId).delete();
                alert('×”×˜×™×¤×•×œ × ××—×§ ×‘×”×¦×œ×—×”');
                await loadMaintenanceHistory(currentCarId);
            } catch (error) {
                console.error('Error deleting maintenance:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×”×˜×™×¤×•×œ');
            }
        }

        // Remove Maintenance Image
        function removeMaintenanceImage(index) {
            maintenanceImages.splice(index, 1);
            document.getElementById('maintenanceImagesPreview').innerHTML = 
                maintenanceImages.map((img, i) => `
                    <div class="relative">
                        <img src="${img}" class="w-full h-24 object-cover rounded">
                        <button type="button" onclick="removeMaintenanceImage(${i})" class="absolute top-0 right-0 bg-red-500 text-white rounded-full w-6 h-6 text-xs">Ã—</button>
                    </div>
                `).join('');
        }

        // Maintenance Form Submit
        document.getElementById('maintenanceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = '×©×•××¨...';
            
            try {
                const maintenanceData = {
                    carId: currentCarId,
                    userId: currentUser.uid,
                    entryDate: document.getElementById('entryDate').value,
                    exitDate: document.getElementById('exitDate').value,
                    workDescription: document.getElementById('workDescription').value,
                    parts: document.getElementById('parts').value,
                    totalCost: parseFloat(document.getElementById('totalCost').value) || 0,
                    notes: document.getElementById('notes').value,
                    images: maintenanceImages,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Handle new images
                const imageFiles = document.getElementById('maintenanceImages').files;
                if (imageFiles.length > 0) {
                    submitBtn.textContent = '×“×•×—×¡ ×ª××•× ×•×ª...';
                    
                    for (let i = 0; i < Math.min(imageFiles.length, 5); i++) {
                        try {
                            const compressed = await compressImage(imageFiles[i], 500);
                            maintenanceImages.push(compressed);
                        } catch (err) {
                            console.error('Image compression error:', err);
                        }
                    }
                    
                    maintenanceData.images = maintenanceImages;
                }
                
                submitBtn.textContent = '×©×•××¨ × ×ª×•× ×™×...';
                
                if (editingMaintenanceId) {
                    await db.collection('maintenance').doc(editingMaintenanceId).update(maintenanceData);
                    alert('×”×˜×™×¤×•×œ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!');
                } else {
                    maintenanceData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('maintenance').add(maintenanceData);
                    alert('×”×˜×™×¤×•×œ × ×•×¡×£ ×‘×”×¦×œ×—×”!');
                }
                
                closeMaintenanceModal();
                await loadMaintenanceHistory(currentCarId);
                
            } catch (error) {
                console.error('Error saving maintenance:', error);
                alert('×©×’×™××”: ' + (error.message || '×œ× × ×™×ª×Ÿ ×œ×©××•×¨ ××ª ×”× ×ª×•× ×™×'));
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // Search Cars
        function searchCars() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const cards = document.querySelectorAll('.car-card');
            
            cards.forEach(card => {
                const text = card.dataset.search.toLowerCase();
                card.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        // Export CSV
        function exportCSV() {
            if (cars.length === 0) {
                alert('××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•×');
                return;
            }
            
            let csv = '××¡×¤×¨ ×¨×™×©×•×™,×©× ×‘×¢×œ×™×,×˜×œ×¤×•×Ÿ,×¡×•×’,×“×’×,×©× ×”\n';
            cars.forEach(car => {
                csv += `${car.plateNumber},${car.ownerName || ''},${car.phone || ''},${car.carType || ''},${car.model || ''},${car.year || ''}\n`;
            });
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `cars_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Sign Out
        async function signOut() {
            if (confirm('×”×× ×œ×¦××ª ××”××¢×¨×›×ª?')) {
                await auth.signOut();
            }
        }

        // Show Message
        function showMessage(message, type) {
            const errorDiv = document.getElementById('errorMsg');
            const successDiv = document.getElementById('successMsg');
            
            if (type === 'error') {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
                successDiv.classList.add('hidden');
            } else {
                successDiv.textContent = message;
                successDiv.classList.remove('hidden');
                errorDiv.classList.add('hidden');
            }
            
            setTimeout(() => {
                errorDiv.classList.add('hidden');
                successDiv.classList.add('hidden');
            }, 5000);
        }

        // Image Preview
        document.getElementById('carImage').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            const previewDiv = document.getElementById('imagePreview');
            
            if (file) {
                if (!file.type.match(/image\/(jpeg|jpg|png|gif)/)) {
                    alert('×¤×•×¨××˜ ×œ× × ×ª××š. ×”×©×ª××© ×‘-JPG ××• PNG');
                    e.target.value = '';
                    previewDiv.innerHTML = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const originalSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    const compressed = await compressImage(file, 700);
                    const compressedSizeKB = (compressed.length / 1024 / 1.37).toFixed(0);
                    
                    previewDiv.innerHTML = `
                        <img src="${compressed}" class="w-32 h-32 object-cover rounded mt-2 border">
                        <p class="text-xs text-green-600 mt-1">âœ“ ×“×—×•×¡ ××•×˜×•××˜×™×ª</p>
                        <p class="text-xs text-gray-500">${originalSizeMB}MB â†’ ${compressedSizeKB}KB</p>
                    `;
                };
                reader.readAsDataURL(file);
            } else {
                previewDiv.innerHTML = '';
            }
        });

        // Maintenance Images Preview
        document.getElementById('maintenanceImages').addEventListener('change', async (e) => {
            const files = e.target.files;
            const previewDiv = document.getElementById('maintenanceImagesPreview');
            
            if (files.length > 0) {
                const previews = [];
                for (let i = 0; i < Math.min(files.length, 5); i++) {
                    const file = files[i];
                    if (file.type.match(/image\/(jpeg|jpg|png|gif)/)) {
                        const reader = new FileReader();
                        const preview = await new Promise((resolve) => {
                            reader.onload = (e) => resolve(e.target.result);
                            reader.readAsDataURL(file);
                        });
                        previews.push(preview);
                    }
                }
                
                previewDiv.innerHTML = previews.map((img, i) => `
                    <img src="${img}" class="w-full h-24 object-cover rounded">
                `).join('');
            }
        });
    </script>

</body>
</html>
