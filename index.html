<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª × ×™×”×•×œ ××•×¡×š</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase v9 Compatible Mode -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        :root {
            --primary: #f59e0b;
            --primary-dark: #d97706;
            --primary-light: #fbbf24;
            --secondary: #0f172a;
            --secondary-light: #1e293b;
            --accent: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --white: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 6px 12px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 25px -5px rgb(0 0 0 / 0.15);
            --shadow-xl: 0 20px 40px -10px rgb(0 0 0 / 0.2);
            
            /* Light Mode Colors */
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --text-tertiary: #94a3b8;
            --border-color: #e2e8f0;
            --card-bg: #ffffff;
        }
        
        /* Dark Mode */
        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --border-color: #334155;
            --card-bg: #1e293b;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.3);
            --shadow-md: 0 6px 12px -2px rgb(0 0 0 / 0.4);
            --shadow-lg: 0 10px 25px -5px rgb(0 0 0 / 0.5);
            --shadow-xl: 0 20px 40px -10px rgb(0 0 0 / 0.6);
        }
        
        /* Dark Mode - Text Colors Override */
        [data-theme="dark"] .text-gray-900,
        [data-theme="dark"] h1,
        [data-theme="dark"] h2,
        [data-theme="dark"] h3 {
            color: #f8fafc !important;
        }
        
        [data-theme="dark"] .text-gray-700,
        [data-theme="dark"] .text-gray-800,
        [data-theme="dark"] label {
            color: #e2e8f0 !important;
        }
        
        [data-theme="dark"] .text-gray-600 {
            color: #cbd5e1 !important;
        }
        
        [data-theme="dark"] .text-gray-500 {
            color: #94a3b8 !important;
        }
        
        [data-theme="dark"] .text-gray-400 {
            color: #64748b !important;
        }
        
        /* Dark Mode - Background Colors */
        [data-theme="dark"] .bg-white {
            background-color: #1e293b !important;
        }
        
        [data-theme="dark"] .bg-gray-50,
        [data-theme="dark"] .bg-gray-100 {
            background-color: #334155 !important;
        }
        
        /* Dark Mode - Borders */
        [data-theme="dark"] .border-gray-200,
        [data-theme="dark"] .border-gray-300 {
            border-color: #475569 !important;
        }
        
        /* Dark Mode - Inputs */
        [data-theme="dark"] input,
        [data-theme="dark"] select,
        [data-theme="dark"] textarea {
            background-color: #334155 !important;
            color: #f8fafc !important;
            border-color: #475569 !important;
        }
        
        [data-theme="dark"] input::placeholder,
        [data-theme="dark"] select::placeholder,
        [data-theme="dark"] textarea::placeholder {
            color: #94a3b8 !important;
        }
        
        /* Dark Mode - Modal */
        [data-theme="dark"] .modal-content,
        [data-theme="dark"] #carModal > div,
        [data-theme="dark"] #carSelectorModal > div {
            background-color: #1e293b !important;
        }
        
        /* Dark Mode - Cards remain visible */
        [data-theme="dark"] .card {
            background-color: #1e293b !important;
            border-color: #475569 !important;
        }
        
        /* Dark Mode - Amber colors remain visible */
        [data-theme="dark"] .text-amber-600,
        [data-theme="dark"] .text-amber-700,
        [data-theme="dark"] .text-amber-800 {
            /* Keep amber colors as they are visible in dark mode */
        }
        
        /* Dark Mode - Select elements */
        [data-theme="dark"] select option {
            background-color: #1e293b !important;
            color: #f8fafc !important;
        }
        
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-tertiary) 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        /* Dark Mode Toggle Button */
        .theme-toggle {
            position: relative;
            width: 60px;
            height: 32px;
            background: var(--bg-tertiary);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 4px;
            flex-shrink: 0;
        }
        
        .theme-toggle-slider {
            width: 24px;
            height: 24px;
            background: var(--primary);
            border-radius: 50%;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            will-change: transform;
        }
        
        [data-theme="dark"] .theme-toggle-slider {
            transform: translateX(28px);
        }
        
        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .logo-badge {
                font-size: 1.5rem;
                width: 50px;
                height: 50px;
            }
            
            h1 {
                font-size: 1.5rem !important;
            }
            
            .icon-button {
                padding: 0.5rem;
            }
            
            .icon-button span {
                display: none;
            }
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            font-size: 1rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background: var(--bg-secondary);
            transform: translateY(-2px);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 0.75rem;
            font-size: 1rem;
            transition: all 0.2s ease;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }
        
        .logo-badge {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            box-shadow: var(--shadow-lg);
            transition: transform 0.3s ease;
            flex-shrink: 0;
        }
        
        .logo-badge:hover {
            transform: rotate(-10deg) scale(1.05);
        }
        
        .status-badge {
            padding: 0.375rem 0.875rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
        }
        
        .status-active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        
        .status-in-service {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        
        .status-completed {
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            animation: fadeIn 0.2s ease;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .modal-content {
            background: var(--card-bg);
            border-radius: 1.5rem;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s ease;
            position: relative;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .icon-button {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .icon-button:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        /* WhatsApp Button Style */
        .whatsapp-btn {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
        }
        
        .whatsapp-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--card-bg) 0%, var(--bg-tertiary) 100%);
            border: 2px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(245, 158, 11, 0.1);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
            margin: 2rem auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        /* Responsive Grid */
        @media (max-width: 768px) {
            .modal-content {
                padding: 1.5rem;
                margin: 0.5rem;
            }
            
            .stat-number {
                font-size: 2rem;
            }
            
            h2 {
                font-size: 1.5rem;
            }
        }
        
        /* Animation for cards */
        @keyframes cardEntry {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-entry {
            animation: cardEntry 0.3s ease forwards;
        }
        
        /* Better focus states */
        button:focus, input:focus, select:focus, textarea:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
        
        /* Print styles */
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background: white;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #e5e7eb;
                page-break-inside: avoid;
            }
        }

        /* API Loading Indicator */
        .api-loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(245, 158, 11, 0.3);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 8px;
        }

        .api-success {
            color: var(--success);
            font-size: 0.875rem;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .api-error {
            color: var(--danger);
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-gradient-to-br from-amber-600 to-amber-800 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="logo-badge bg-white text-amber-600 mb-4 mx-auto">
                ğŸ”§
            </div>
            <h2 class="text-3xl font-bold text-white mb-4">××¢×¨×›×ª × ×™×”×•×œ ××•×¡×š</h2>
            <div class="spinner border-white border-t-amber-200"></div>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="card max-w-md w-full">
            <div class="text-center mb-8">
                <div class="logo-badge mx-auto mb-4">ğŸ”§</div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">××¢×¨×›×ª × ×™×”×•×œ ××•×¡×š</h1>
                <p class="text-gray-600">×”×ª×—×‘×¨ ×›×“×™ ×œ×”××©×™×š</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">××™××™×™×œ</label>
                    <input type="email" id="loginEmail" required 
                           class="w-full" placeholder="example@email.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">×¡×™×¡××”</label>
                    <input type="password" id="loginPassword" required 
                           class="w-full" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <button type="submit" class="btn btn-primary w-full">
                    ×›× ×™×¡×”
                </button>
                <p class="text-center text-sm text-gray-600 mt-4">
                    ××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ? 
                    <a href="#" onclick="showRegister(); return false;" class="text-amber-600 hover:text-amber-700 font-semibold">×”×™×¨×©× ×›××Ÿ</a>
                </p>
            </form>
        </div>
    </div>

    <!-- Register Screen -->
    <div id="registerScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="card max-w-md w-full">
            <div class="text-center mb-8">
                <div class="logo-badge mx-auto mb-4">ğŸ”§</div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">×”×¨×©××” ×œ××¢×¨×›×ª</h1>
                <p class="text-gray-600">×¦×•×¨ ×—×©×‘×•×Ÿ ×—×“×©</p>
            </div>
            
            <form id="registerForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">×©× ××œ×</label>
                    <input type="text" id="registerName" required 
                           class="w-full" placeholder="×©× ××œ×">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">××™××™×™×œ</label>
                    <input type="email" id="registerEmail" required 
                           class="w-full" placeholder="example@email.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">×¡×™×¡××”</label>
                    <input type="password" id="registerPassword" required 
                           class="w-full" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" minlength="6">
                </div>
                <button type="submit" class="btn btn-primary w-full">
                    ×”×™×¨×©×
                </button>
                <p class="text-center text-sm text-gray-600 mt-4">
                    ×™×© ×œ×š ×›×‘×¨ ×—×©×‘×•×Ÿ? 
                    <a href="#" onclick="showLogin(); return false;" class="text-amber-600 hover:text-amber-700 font-semibold">×”×ª×—×‘×¨ ×›××Ÿ</a>
                </p>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden min-h-screen p-4 md:p-8">
        <!-- Header -->
        <header class="card mb-8">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <div class="logo-badge">ğŸ”§</div>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-900">××¢×¨×›×ª × ×™×”×•×œ ××•×¡×š</h1>
                        <p class="text-gray-600">× ×™×”×•×œ ×¨×›×‘×™×, ×˜×™×¤×•×œ×™× ×•×¤×’×™×©×•×ª</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 md:gap-4">
                    <div class="theme-toggle" onclick="toggleTheme()">
                        <div class="theme-toggle-slider">
                            <span id="themeIcon">ğŸŒ™</span>
                        </div>
                    </div>
                    <button onclick="openDashboard()" class="icon-button">
                        <span>ğŸ“Š</span>
                        <span class="hidden md:inline">×¡×˜×˜×™×¡×˜×™×§×•×ª</span>
                    </button>
                    <button onclick="openCalendarModal()" class="icon-button">
                        <span>ğŸ“…</span>
                        <span class="hidden md:inline">×™×•××Ÿ</span>
                    </button>
                    <button onclick="handleBackup()" class="icon-button">
                        <span>ğŸ’¾</span>
                        <span class="hidden md:inline">×’×™×‘×•×™</span>
                    </button>
                    <button onclick="logout()" class="icon-button">
                        <span>ğŸšª</span>
                        <span class="hidden md:inline">×™×¦×™××”</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <button onclick="openCarModal()" class="btn btn-primary text-lg py-4">
                â• ×”×•×¡×£ ×¨×›×‘ ×—×“×©
            </button>
            <button onclick="openMaintenanceModal()" class="btn btn-primary text-lg py-4">
                ğŸ”§ ×¨×™×©×•× ×˜×™×¤×•×œ
            </button>
            <button onclick="openAppointmentModal()" class="btn btn-primary text-lg py-4">
                ğŸ“… ×§×‘×™×¢×ª ×¤×’×™×©×”
            </button>
        </div>

        <!-- Search and Filter -->
        <div class="card mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="searchInput" placeholder="ğŸ” ×—×™×¤×•×© ×œ×¤×™ ××¡×¤×¨ ×¨×›×‘, ×™×¦×¨×Ÿ ××• ×‘×¢×œ×™×..." 
                       onkeyup="filterCars()" class="col-span-1 md:col-span-2">
                <select id="statusFilter" onchange="filterCars()">
                    <option value="">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                    <option value="×¤×¢×™×œ">×¤×¢×™×œ</option>
                    <option value="×‘×˜×™×¤×•×œ">×‘×˜×™×¤×•×œ</option>
                    <option value="×”×•×©×œ×">×”×•×©×œ×</option>
                </select>
            </div>
        </div>

        <!-- Cars List -->
        <div id="carsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Cars will be dynamically loaded here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-16">
            <div class="text-6xl mb-4">ğŸš—</div>
            <h3 class="text-2xl font-bold text-gray-900 mb-2">××™×Ÿ ×¨×›×‘×™× ×‘××¢×¨×›×ª</h3>
            <p class="text-gray-600 mb-6">×”×ª×—×œ ×¢×œ ×™×“×™ ×”×•×¡×¤×ª ×”×¨×›×‘ ×”×¨××©×•×Ÿ ×©×œ×š</p>
            <button onclick="openCarModal()" class="btn btn-primary">
                â• ×”×•×¡×£ ×¨×›×‘ ×—×“×©
            </button>
        </div>
    </div>

    <!-- Car Modal -->
    <div id="carModal" class="modal hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900" id="carModalTitle">×”×•×¡×£ ×¨×›×‘ ×—×“×©</h2>
                <button onclick="closeCarModal()" class="text-gray-500 hover:text-gray-700 text-3xl">&times;</button>
            </div>
            <form id="carForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">××¡×¤×¨ ×¨×›×‘ *</label>
                    <input type="text" id="carNumber" required 
                           placeholder="1234567" 
                           maxlength="8"
                           class="w-full">
                    <div id="apiStatus" class="mt-2"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">×™×¦×¨×Ÿ *</label>
                        <input type="text" id="carManufacturer" required class="w-full" placeholder="×˜×•×™×•×˜×”">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">×“×’× *</label>
                        <input type="text" id="carModel" required class="w-full" placeholder="×§×•×¨×•×œ×”">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">×©× ×”</label>
                        <input type="number" id="carYear" class="w-full" placeholder="2020" min="1900" max="2030">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">×¦×‘×¢</label>
                        <input type="text" id="carColor" class="w-full" placeholder="×œ×‘×Ÿ">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">×©× ×”×‘×¢×œ×™× *</label>
                    <input type="text" id="ownerName" required class="w-full" placeholder="×©× ××œ×">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">×˜×œ×¤×•×Ÿ *</label>
                    <input type="tel" id="ownerPhone" required class="w-full" placeholder="050-1234567">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">××™××™×™×œ</label>
                    <input type="email" id="ownerEmail" class="w-full" placeholder="email@example.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">×”×¢×¨×•×ª</label>
                    <textarea id="carNotes" rows="3" class="w-full" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª..."></textarea>
                </div>
                <div class="flex gap-4">
                    <button type="submit" class="btn btn-primary flex-1">
                        ğŸ’¾ ×©××•×¨ ×¨×›×‘
                    </button>
                    <button type="button" onclick="closeCarModal()" class="btn btn-secondary flex-1">
                        ×‘×™×˜×•×œ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Car Details Modal -->
    <div id="carDetailsModal" class="modal hidden">
        <div class="modal-content max-w-4xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">×¤×¨×˜×™ ×¨×›×‘</h2>
                <button onclick="closeCarDetailsModal()" class="text-gray-500 hover:text-gray-700 text-3xl">&times;</button>
            </div>
            <div id="carDetailsContent">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Maintenance Modal -->
    <div id="maintenanceModal" class="modal hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">×¨×™×©×•× ×˜×™×¤×•×œ</h2>
                <button onclick="closeMaintenanceModal()" class="text-gray-500 hover:text-gray-700 text-3xl">&times;</button>
            </div>
            <form id="maintenanceForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">×‘×—×¨ ×¨×›×‘ *</label>
                    <select id="maintenanceCarId" required class="w-full">
                        <option value="">×‘×—×¨ ×¨×›×‘...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">×¡×•×’ ×˜×™×¤×•×œ *</label>
                    <select id="maintenanceType" required class="w-full">
                        <option value="">×‘×—×¨ ×¡×•×’ ×˜×™×¤×•×œ...</option>
                        <option value="×©×™×¨×•×ª ×ª×§×•×¤×ª×™">×©×™×¨×•×ª ×ª×§×•×¤×ª×™</option>
                        <option value="×ª×™×§×•×Ÿ">×ª×™×§×•×Ÿ</option>
                        <option value="×”×—×œ×¤×ª ×©××Ÿ">×”×—×œ×¤×ª ×©××Ÿ</option>
                        <option value="×‘×“×™×§×” ×©× ×ª×™×ª">×‘×“×™×§×” ×©× ×ª×™×ª</option>
                        <option value="××—×¨">××—×¨</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">×ª×™××•×¨ ×”×˜×™×¤×•×œ *</label>
                    <textarea id="maintenanceDescription" required rows="4" class="w-full" 
                              placeholder="×¤×¨×˜ ××ª ×”×˜×™×¤×•×œ×™× ×©×‘×•×¦×¢×•..."></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">×¢×œ×•×ª (â‚ª)</label>
                        <input type="number" id="maintenanceCost" class="w-full" placeholder="0" min="0" step="0.01">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">×§×™×œ×•××˜×¨××–'</label>
                        <input type="number" id="maintenanceMileage" class="w-full" placeholder="0" min="0">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">×”×¢×¨×•×ª</label>
                    <textarea id="maintenanceNotes" rows="2" class="w-full" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª..."></textarea>
                </div>
                <div class="flex gap-4">
                    <button type="submit" class="btn btn-primary flex-1">
                        ğŸ’¾ ×©××•×¨ ×˜×™×¤×•×œ
                    </button>
                    <button type="button" onclick="closeMaintenanceModal()" class="btn btn-secondary flex-1">
                        ×‘×™×˜×•×œ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Calendar Modal -->
    <div id="calendarModal" class="modal hidden">
        <div class="modal-content max-w-4xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">×™×•××Ÿ ×¤×’×™×©×•×ª</h2>
                <button onclick="closeCalendarModal()" class="text-gray-500 hover:text-gray-700 text-3xl">&times;</button>
            </div>
            <div id="calendarContent">
                <!-- Calendar will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Appointment Modal -->
    <div id="appointmentModal" class="modal hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">×§×‘×™×¢×ª ×¤×’×™×©×”</h2>
                <button onclick="closeAppointmentModal()" class="text-gray-500 hover:text-gray-700 text-3xl">&times;</button>
            </div>
            <form id="appointmentForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">×‘×—×¨ ×¨×›×‘ *</label>
                    <select id="appointmentCarId" required class="w-full">
                        <option value="">×‘×—×¨ ×¨×›×‘...</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">×ª××¨×™×š *</label>
                        <input type="date" id="appointmentDate" required class="w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">×©×¢×” *</label>
                        <input type="time" id="appointmentTime" required class="w-full">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">×¡×•×’ ×”×¤×’×™×©×” *</label>
                    <select id="appointmentType" required class="w-full">
                        <option value="">×‘×—×¨ ×¡×•×’...</option>
                        <option value="×©×™×¨×•×ª ×ª×§×•×¤×ª×™">×©×™×¨×•×ª ×ª×§×•×¤×ª×™</option>
                        <option value="×ª×™×§×•×Ÿ">×ª×™×§×•×Ÿ</option>
                        <option value="×‘×“×™×§×”">×‘×“×™×§×”</option>
                        <option value="×™×™×¢×•×¥">×™×™×¢×•×¥</option>
                        <option value="××—×¨">××—×¨</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">×”×¢×¨×•×ª</label>
                    <textarea id="appointmentNotes" rows="3" class="w-full" placeholder="×¤×¨×˜×™× × ×•×¡×¤×™×..."></textarea>
                </div>
                <div class="flex gap-4">
                    <button type="submit" class="btn btn-primary flex-1">
                        ğŸ’¾ ×©××•×¨ ×¤×’×™×©×”
                    </button>
                    <button type="button" onclick="closeAppointmentModal()" class="btn btn-secondary flex-1">
                        ×‘×™×˜×•×œ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Dashboard Modal -->
    <div id="dashboardModal" class="modal hidden">
        <div class="modal-content max-w-6xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">×¡×˜×˜×™×¡×˜×™×§×•×ª ×•×“×•"×—×•×ª</h2>
                <button onclick="closeDashboard()" class="text-gray-500 hover:text-gray-700 text-3xl">&times;</button>
            </div>
            <div id="dashboardContent">
                <!-- Dashboard content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Backup Progress Modal -->
    <div id="backupProgressModal" class="modal hidden">
        <div class="modal-content max-w-md">
            <div class="text-center">
                <div class="text-4xl mb-4">ğŸ’¾</div>
                <h3 class="text-xl font-bold text-gray-900 mb-4">××‘×¦×¢ ×’×™×‘×•×™...</h3>
                <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
                    <div id="backupProgressBar" class="bg-amber-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="backupProgressText" class="text-gray-600">××ª×—×™×œ...</p>
            </div>
        </div>
    </div>

    <!-- Hidden file input for restore -->
    <input type="file" id="restoreFileInput" accept=".json" style="display: none;" onchange="handleRestoreFile(event)">

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBNl7vah_P3-cqXH7W_EGPqq9qXRFv5lSc",
            authDomain: "mosach-70703.firebaseapp.com",
            projectId: "mosach-70703",
            storageBucket: "mosach-70703.firebasestorage.app",
            messagingSenderId: "836033866363",
            appId: "1:836033866363:web:79cea2f2f23ac5c1cd2cb4"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global Variables
        let currentUser = null;
        let allCars = [];
        let allMaintenance = [];
        let allAppointments = [];
        let editingCarId = null;

        // ==========================================
        // Theme Management
        // ==========================================
        
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            if (icon) {
                icon.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
            }
        }

        // ==========================================
        // Data.gov.il API Integration
        // ==========================================
        
        let apiTimeout = null;

        async function fetchCarDataFromAPI(carNumber) {
            const apiStatus = document.getElementById('apiStatus');
            
            // Show loading
            apiStatus.innerHTML = '<div class="api-loading"></div><span style="color: var(--text-secondary);">××—×¤×© ××™×“×¢ ×‘×¨×©×•×™×•×ª...</span>';
            
            try {
                // Clean the car number (remove any existing dashes)
                const cleanCarNumber = carNumber.replace(/[-\s]/g, '');
                
                // Call the Israeli government API
                const response = await fetch(`https://data.gov.il/api/3/action/datastore_search?resource_id=053cea08-09bc-40ec-8f7a-156f0677aff3&q=${cleanCarNumber}`);
                
                if (!response.ok) {
                    throw new Error('×©×’×™××” ×‘×§×‘×œ×ª × ×ª×•× ×™×');
                }
                
                const data = await response.json();
                
                if (data.success && data.result.records && data.result.records.length > 0) {
                    const carInfo = data.result.records[0];
                    
                    // Fill in the form with API data
                    if (carInfo.tozeret_nm) {
                        document.getElementById('carManufacturer').value = carInfo.tozeret_nm;
                    }
                    if (carInfo.kinuy_mishari) {
                        document.getElementById('carModel').value = carInfo.kinuy_mishari;
                    }
                    if (carInfo.shnat_yitzur) {
                        document.getElementById('carYear').value = carInfo.shnat_yitzur;
                    }
                    if (carInfo.tzeva_rechev) {
                        document.getElementById('carColor').value = carInfo.tzeva_rechev;
                    }
                    
                    // Show success message
                    apiStatus.innerHTML = '<div class="api-success">âœ“ × ××¦××• ×¤×¨×˜×™ ×”×¨×›×‘ ×‘××¢×¨×›×ª</div>';
                    
                    // Clear success message after 3 seconds
                    setTimeout(() => {
                        apiStatus.innerHTML = '';
                    }, 3000);
                } else {
                    // No data found
                    apiStatus.innerHTML = '<div class="api-error">×œ× × ××¦××• ×¤×¨×˜×™× ×¢×‘×•×¨ ××¡×¤×¨ ×¨×›×‘ ×–×”</div>';
                    setTimeout(() => {
                        apiStatus.innerHTML = '';
                    }, 3000);
                }
            } catch (error) {
                console.error('Error fetching car data:', error);
                apiStatus.innerHTML = '<div class="api-error">×©×’×™××” ×‘×—×™×¤×•×© ××™×“×¢ - × ×™×ª×Ÿ ×œ×”×–×™×Ÿ ×™×“× ×™×ª</div>';
                setTimeout(() => {
                    apiStatus.innerHTML = '';
                }, 3000);
            }
        }

        // Auto-format car number and trigger API search
        document.addEventListener('DOMContentLoaded', function() {
            const carNumberInput = document.getElementById('carNumber');
            
            if (carNumberInput) {
                carNumberInput.addEventListener('input', function(e) {
                    // Remove all non-digit characters
                    let value = e.target.value.replace(/\D/g, '');
                    
                    // Update the input with clean number (no dashes)
                    e.target.value = value;
                    
                    // Clear previous timeout
                    if (apiTimeout) {
                        clearTimeout(apiTimeout);
                    }
                    
                    // Only search if we have at least 7 digits
                    if (value.length >= 7) {
                        apiTimeout = setTimeout(() => {
                            fetchCarDataFromAPI(value);
                        }, 500); // Wait 500ms after user stops typing
                    } else {
                        // Clear API status if less than 7 digits
                        const apiStatus = document.getElementById('apiStatus');
                        if (apiStatus) {
                            apiStatus.innerHTML = '';
                        }
                    }
                });
            }
        });

        // ==========================================
        // Authentication
        // ==========================================
        
        // Check Auth State
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                showMainApp();
                loadAllData();
            } else {
                showLogin();
            }
        });

        // Login Form
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                alert('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª: ' + error.message);
            }
        });

        // Register Form
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await userCredential.user.updateProfile({ displayName: name });
                alert('×”×”×¨×©××” ×”×•×©×œ××” ×‘×”×¦×œ×—×”!');
            } catch (error) {
                alert('×©×’×™××” ×‘×”×¨×©××”: ' + error.message);
            }
        });

        // Logout
        function logout() {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×ª× ×ª×§?')) {
                auth.signOut();
            }
        }

        // Show/Hide Screens
        function showLogin() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('registerScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('registerScreen').classList.remove('hidden');
        }

        function showMainApp() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('registerScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }

        // ==========================================
        // Data Loading
        // ==========================================
        
        async function loadAllData() {
            try {
                await Promise.all([
                    loadCars(),
                    loadMaintenance(),
                    loadAppointments()
                ]);
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function loadCars() {
            try {
                const snapshot = await db.collection('cars')
                    .where('userId', '==', currentUser.uid)
                    .where('status', '!=', 'deleted')
                    .orderBy('status')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                allCars = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                displayCars(allCars);
                updateCarSelectors();
            } catch (error) {
                console.error('Error loading cars:', error);
                alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×¨×›×‘×™×');
            }
        }

        async function loadMaintenance() {
            try {
                const snapshot = await db.collection('maintenance')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                allMaintenance = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading maintenance:', error);
            }
        }

        async function loadAppointments() {
            try {
                const snapshot = await db.collection('appointments')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                allAppointments = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading appointments:', error);
            }
        }

        // ==========================================
        // Display Functions
        // ==========================================
        
        function displayCars(cars) {
            const carsList = document.getElementById('carsList');
            const emptyState = document.getElementById('emptyState');
            
            if (cars.length === 0) {
                carsList.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            carsList.innerHTML = cars.map((car, index) => `
                <div class="card animate-entry" style="animation-delay: ${index * 0.05}s">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-gray-900 mb-1">${car.carNumber}</h3>
                            <p class="text-gray-600">${car.manufacturer} ${car.model}</p>
                        </div>
                        <span class="status-badge status-${car.status === '×¤×¢×™×œ' ? 'active' : car.status === '×‘×˜×™×¤×•×œ' ? 'in-service' : 'completed'}">
                            ${car.status}
                        </span>
                    </div>
                    
                    <div class="space-y-2 mb-4">
                        <div class="flex items-center gap-2 text-sm text-gray-600">
                            <span>ğŸ‘¤</span>
                            <span>${car.ownerName}</span>
                        </div>
                        <div class="flex items-center gap-2 text-sm text-gray-600">
                            <span>ğŸ“</span>
                            <span>${car.ownerPhone}</span>
                        </div>
                        ${car.year ? `
                        <div class="flex items-center gap-2 text-sm text-gray-600">
                            <span>ğŸ“…</span>
                            <span>×©× ×”: ${car.year}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="openCarDetailsModal('${car.id}')" class="btn btn-primary flex-1 text-sm py-2">
                            ğŸ“‹ ×¤×¨×˜×™×
                        </button>
                        <button onclick="editCar('${car.id}')" class="btn btn-secondary flex-1 text-sm py-2">
                            âœï¸ ×¢×¨×™×›×”
                        </button>
                        <button onclick="sendWhatsApp('${car.ownerPhone}', '${car.ownerName}')" class="btn whatsapp-btn text-sm py-2">
                            ğŸ’¬
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function filterCars() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            const filtered = allCars.filter(car => {
                const matchesSearch = 
                    car.carNumber.toLowerCase().includes(searchTerm) ||
                    car.manufacturer.toLowerCase().includes(searchTerm) ||
                    car.model.toLowerCase().includes(searchTerm) ||
                    car.ownerName.toLowerCase().includes(searchTerm);
                
                const matchesStatus = !statusFilter || car.status === statusFilter;
                
                return matchesSearch && matchesStatus;
            });
            
            displayCars(filtered);
        }

        function updateCarSelectors() {
            const activeCars = allCars.filter(car => car.status !== 'deleted');
            const options = activeCars.map(car => 
                `<option value="${car.id}">${car.carNumber} - ${car.manufacturer} ${car.model}</option>`
            ).join('');
            
            document.getElementById('maintenanceCarId').innerHTML = '<option value="">×‘×—×¨ ×¨×›×‘...</option>' + options;
            document.getElementById('appointmentCarId').innerHTML = '<option value="">×‘×—×¨ ×¨×›×‘...</option>' + options;
        }

        // ==========================================
        // Car CRUD Operations
        // ==========================================
        
        function openCarModal() {
            editingCarId = null;
            document.getElementById('carModalTitle').textContent = '×”×•×¡×£ ×¨×›×‘ ×—×“×©';
            document.getElementById('carForm').reset();
            document.getElementById('apiStatus').innerHTML = '';
            document.getElementById('carModal').classList.remove('hidden');
        }

        function closeCarModal() {
            editingCarId = null;
            document.getElementById('carModal').classList.add('hidden');
            document.getElementById('carForm').reset();
            document.getElementById('apiStatus').innerHTML = '';
        }

        async function editCar(carId) {
            const car = allCars.find(c => c.id === carId);
            if (!car) return;
            
            editingCarId = carId;
            document.getElementById('carModalTitle').textContent = '×¢×¨×™×›×ª ×¨×›×‘';
            
            // Fill form
            document.getElementById('carNumber').value = car.carNumber;
            document.getElementById('carManufacturer').value = car.manufacturer;
            document.getElementById('carModel').value = car.model;
            document.getElementById('carYear').value = car.year || '';
            document.getElementById('carColor').value = car.color || '';
            document.getElementById('ownerName').value = car.ownerName;
            document.getElementById('ownerPhone').value = car.ownerPhone;
            document.getElementById('ownerEmail').value = car.ownerEmail || '';
            document.getElementById('carNotes').value = car.notes || '';
            
            document.getElementById('carModal').classList.remove('hidden');
        }

        // Car Form Submit
        document.getElementById('carForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Get clean car number (no dashes)
            const carNumber = document.getElementById('carNumber').value.replace(/[-\s]/g, '');
            
            const carData = {
                carNumber: carNumber,
                manufacturer: document.getElementById('carManufacturer').value,
                model: document.getElementById('carModel').value,
                year: document.getElementById('carYear').value || null,
                color: document.getElementById('carColor').value || null,
                ownerName: document.getElementById('ownerName').value,
                ownerPhone: document.getElementById('ownerPhone').value,
                ownerEmail: document.getElementById('ownerEmail').value || null,
                notes: document.getElementById('carNotes').value || null,
                status: '×¤×¢×™×œ',
                userId: currentUser.uid,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                if (editingCarId) {
                    await db.collection('cars').doc(editingCarId).update(carData);
                    alert('×”×¨×›×‘ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!');
                } else {
                    carData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('cars').add(carData);
                    alert('×”×¨×›×‘ × ×•×¡×£ ×‘×”×¦×œ×—×”!');
                }
                
                closeCarModal();
                await loadCars();
            } catch (error) {
                console.error('Error saving car:', error);
                alert('×©×’×™××” ×‘×©××™×¨×ª ×”×¨×›×‘');
            }
        });

        async function deleteCar(carId) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×¨×›×‘? ×¤×¢×•×œ×” ×–×• ××™× ×” × ×™×ª× ×ª ×œ×‘×™×˜×•×œ.')) {
                return;
            }
            
            try {
                // Update status to deleted instead of actually deleting
                await db.collection('cars').doc(carId).update({
                    status: 'deleted',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('×”×¨×›×‘ ×”×•×¡×¨ ×‘×”×¦×œ×—×”!');
                closeCarDetailsModal();
                await loadCars();
            } catch (error) {
                console.error('Error deleting car:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×”×¨×›×‘');
            }
        }

        // ==========================================
        // Car Details Modal
        // ==========================================
        
        function openCarDetailsModal(carId) {
            const car = allCars.find(c => c.id === carId);
            if (!car) return;
            
            const carMaintenance = allMaintenance.filter(m => m.carId === carId);
            const totalCost = carMaintenance.reduce((sum, m) => sum + (parseFloat(m.cost) || 0), 0);
            
            const content = `
                <div class="space-y-6">
                    <!-- Car Info -->
                    <div class="card">
                        <h3 class="text-xl font-bold text-gray-900 mb-4">×¤×¨×˜×™ ×”×¨×›×‘</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">××¡×¤×¨ ×¨×›×‘</p>
                                <p class="font-semibold">${car.carNumber}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">×™×¦×¨×Ÿ</p>
                                <p class="font-semibold">${car.manufacturer}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">×“×’×</p>
                                <p class="font-semibold">${car.model}</p>
                            </div>
                            ${car.year ? `
                            <div>
                                <p class="text-sm text-gray-600">×©× ×”</p>
                                <p class="font-semibold">${car.year}</p>
                            </div>
                            ` : ''}
                            ${car.color ? `
                            <div>
                                <p class="text-sm text-gray-600">×¦×‘×¢</p>
                                <p class="font-semibold">${car.color}</p>
                            </div>
                            ` : ''}
                            <div>
                                <p class="text-sm text-gray-600">×‘×¢×œ×™×</p>
                                <p class="font-semibold">${car.ownerName}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">×˜×œ×¤×•×Ÿ</p>
                                <p class="font-semibold">${car.ownerPhone}</p>
                            </div>
                            ${car.ownerEmail ? `
                            <div>
                                <p class="text-sm text-gray-600">××™××™×™×œ</p>
                                <p class="font-semibold">${car.ownerEmail}</p>
                            </div>
                            ` : ''}
                        </div>
                        ${car.notes ? `
                        <div class="mt-4">
                            <p class="text-sm text-gray-600">×”×¢×¨×•×ª</p>
                            <p class="font-semibold">${car.notes}</p>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Maintenance History -->
                    <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-900">×”×™×¡×˜×•×¨×™×™×ª ×˜×™×¤×•×œ×™×</h3>
                            <span class="text-lg font-bold text-amber-600">â‚ª${totalCost.toFixed(2)}</span>
                        </div>
                        
                        ${carMaintenance.length > 0 ? `
                            <div class="space-y-3">
                                ${carMaintenance.map(m => `
                                    <div class="border-r-4 border-amber-500 pr-4 py-2">
                                        <div class="flex justify-between items-start mb-2">
                                            <div>
                                                <p class="font-semibold text-gray-900">${m.type}</p>
                                                <p class="text-sm text-gray-600">${new Date(m.createdAt?.toMillis() || Date.now()).toLocaleDateString('he-IL')}</p>
                                            </div>
                                            ${m.cost ? `<span class="font-bold text-amber-600">â‚ª${parseFloat(m.cost).toFixed(2)}</span>` : ''}
                                        </div>
                                        <p class="text-sm text-gray-700">${m.description}</p>
                                        ${m.mileage ? `<p class="text-xs text-gray-500 mt-1">×§×™×œ×•××˜×¨××–': ${m.mileage}</p>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p class="text-gray-500 text-center py-4">××™×Ÿ ×˜×™×¤×•×œ×™× ×¨×©×•××™×</p>'}
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex gap-3">
                        <button onclick="editCar('${car.id}')" class="btn btn-primary flex-1">
                            âœï¸ ×¢×¨×•×š ×¨×›×‘
                        </button>
                        <button onclick="sendWhatsApp('${car.ownerPhone}', '${car.ownerName}')" class="btn whatsapp-btn flex-1">
                            ğŸ’¬ ×©×œ×— ×”×•×“×¢×”
                        </button>
                        <button onclick="deleteCar('${car.id}')" class="btn btn-danger flex-1">
                            ğŸ—‘ï¸ ××—×§ ×¨×›×‘
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('carDetailsContent').innerHTML = content;
            document.getElementById('carDetailsModal').classList.remove('hidden');
        }

        function closeCarDetailsModal() {
            document.getElementById('carDetailsModal').classList.add('hidden');
        }

        // ==========================================
        // Maintenance Operations
        // ==========================================
        
        function openMaintenanceModal() {
            document.getElementById('maintenanceForm').reset();
            document.getElementById('maintenanceModal').classList.remove('hidden');
        }

        function closeMaintenanceModal() {
            document.getElementById('maintenanceModal').classList.add('hidden');
        }

        document.getElementById('maintenanceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const maintenanceData = {
                carId: document.getElementById('maintenanceCarId').value,
                type: document.getElementById('maintenanceType').value,
                description: document.getElementById('maintenanceDescription').value,
                cost: document.getElementById('maintenanceCost').value || null,
                mileage: document.getElementById('maintenanceMileage').value || null,
                notes: document.getElementById('maintenanceNotes').value || null,
                userId: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                await db.collection('maintenance').add(maintenanceData);
                alert('×”×˜×™×¤×•×œ × ×©××¨ ×‘×”×¦×œ×—×”!');
                closeMaintenanceModal();
                await loadMaintenance();
            } catch (error) {
                console.error('Error saving maintenance:', error);
                alert('×©×’×™××” ×‘×©××™×¨×ª ×”×˜×™×¤×•×œ');
            }
        });

        // ==========================================
        // Appointment Operations
        // ==========================================
        
        function openAppointmentModal() {
            document.getElementById('appointmentForm').reset();
            // Set default date to today
            document.getElementById('appointmentDate').valueAsDate = new Date();
            document.getElementById('appointmentModal').classList.remove('hidden');
        }

        function closeAppointmentModal() {
            document.getElementById('appointmentModal').classList.add('hidden');
        }

        document.getElementById('appointmentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const appointmentData = {
                carId: document.getElementById('appointmentCarId').value,
                date: document.getElementById('appointmentDate').value,
                time: document.getElementById('appointmentTime').value,
                type: document.getElementById('appointmentType').value,
                notes: document.getElementById('appointmentNotes').value || null,
                userId: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                await db.collection('appointments').add(appointmentData);
                alert('×”×¤×’×™×©×” × ×§×‘×¢×” ×‘×”×¦×œ×—×”!');
                closeAppointmentModal();
                await loadAppointments();
            } catch (error) {
                console.error('Error saving appointment:', error);
                alert('×©×’×™××” ×‘×©××™×¨×ª ×”×¤×’×™×©×”');
            }
        });

        // ==========================================
        // Calendar Modal
        // ==========================================
        
        function openCalendarModal() {
            const upcomingAppointments = allAppointments
                .filter(a => new Date(a.date) >= new Date().setHours(0,0,0,0))
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const content = `
                <div class="space-y-4">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">×¤×’×™×©×•×ª ×§×¨×•×‘×•×ª</h3>
                    ${upcomingAppointments.length > 0 ? `
                        <div class="space-y-3">
                            ${upcomingAppointments.map(appointment => {
                                const car = allCars.find(c => c.id === appointment.carId);
                                return `
                                    <div class="card">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <p class="font-bold text-gray-900">${car ? `${car.carNumber} - ${car.manufacturer} ${car.model}` : '×¨×›×‘ ×œ× ×™×“×•×¢'}</p>
                                                <p class="text-sm text-gray-600">${new Date(appointment.date).toLocaleDateString('he-IL')} ×‘×©×¢×” ${appointment.time}</p>
                                                <p class="text-sm text-gray-700 mt-2">${appointment.type}</p>
                                                ${appointment.notes ? `<p class="text-xs text-gray-500 mt-1">${appointment.notes}</p>` : ''}
                                            </div>
                                            <button onclick="deleteAppointment('${appointment.id}')" class="text-red-500 hover:text-red-700">
                                                ğŸ—‘ï¸
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : '<p class="text-gray-500 text-center py-8">××™×Ÿ ×¤×’×™×©×•×ª ×§×¨×•×‘×•×ª</p>'}
                </div>
            `;
            
            document.getElementById('calendarContent').innerHTML = content;
            document.getElementById('calendarModal').classList.remove('hidden');
        }

        function closeCalendarModal() {
            document.getElementById('calendarModal').classList.add('hidden');
        }

        async function deleteAppointment(appointmentId) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×¤×’×™×©×”?')) return;
            
            try {
                await db.collection('appointments').doc(appointmentId).delete();
                await loadAppointments();
                openCalendarModal(); // Refresh the modal
                alert('×”×¤×’×™×©×” × ××—×§×” ×‘×”×¦×œ×—×”!');
            } catch (error) {
                console.error('Error deleting appointment:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×”×¤×’×™×©×”');
            }
        }

        // ==========================================
        // Dashboard
        // ==========================================
        
        function openDashboard() {
            const activeCars = allCars.filter(c => c.status !== 'deleted').length;
            const carsInService = allCars.filter(c => c.status === '×‘×˜×™×¤×•×œ').length;
            const totalMaintenance = allMaintenance.length;
            const totalRevenue = allMaintenance.reduce((sum, m) => sum + (parseFloat(m.cost) || 0), 0);
            const upcomingAppointments = allAppointments.filter(a => new Date(a.date) >= new Date()).length;
            
            const content = `
                <div class="space-y-6">
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="stat-card">
                            <div class="text-3xl mb-2">ğŸš—</div>
                            <div class="stat-number">${activeCars}</div>
                            <div class="text-sm text-gray-600">×¨×›×‘×™× ×‘××¢×¨×›×ª</div>
                        </div>
                        <div class="stat-card">
                            <div class="text-3xl mb-2">ğŸ”§</div>
                            <div class="stat-number">${carsInService}</div>
                            <div class="text-sm text-gray-600">×¨×›×‘×™× ×‘×˜×™×¤×•×œ</div>
                        </div>
                        <div class="stat-card">
                            <div class="text-3xl mb-2">ğŸ“‹</div>
                            <div class="stat-number">${totalMaintenance}</div>
                            <div class="text-sm text-gray-600">×˜×™×¤×•×œ×™× ×©×‘×•×¦×¢×•</div>
                        </div>
                        <div class="stat-card">
                            <div class="text-3xl mb-2">ğŸ’°</div>
                            <div class="stat-number">â‚ª${totalRevenue.toFixed(0)}</div>
                            <div class="text-sm text-gray-600">×”×›× ×¡×•×ª ×›×•×œ×œ×•×ª</div>
                        </div>
                    </div>
                    
                    <!-- Recent Activity -->
                    <div class="card">
                        <h3 class="text-xl font-bold text-gray-900 mb-4">×¤×¢×™×œ×•×ª ××—×¨×•× ×”</h3>
                        ${allMaintenance.length > 0 ? `
                            <div class="space-y-3">
                                ${allMaintenance.slice(0, 5).map(m => {
                                    const car = allCars.find(c => c.id === m.carId);
                                    return `
                                        <div class="flex justify-between items-center border-b border-gray-200 pb-2">
                                            <div>
                                                <p class="font-semibold">${car ? `${car.carNumber}` : '×¨×›×‘ ×œ× ×™×“×•×¢'}</p>
                                                <p class="text-sm text-gray-600">${m.type}</p>
                                            </div>
                                            <div class="text-left">
                                                <p class="font-bold text-amber-600">${m.cost ? `â‚ª${parseFloat(m.cost).toFixed(2)}` : '-'}</p>
                                                <p class="text-xs text-gray-500">${new Date(m.createdAt?.toMillis() || Date.now()).toLocaleDateString('he-IL')}</p>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : '<p class="text-gray-500 text-center py-4">××™×Ÿ ×¤×¢×™×œ×•×ª ××—×¨×•× ×”</p>'}
                    </div>
                    
                    <!-- Upcoming Appointments -->
                    <div class="card">
                        <h3 class="text-xl font-bold text-gray-900 mb-4">×¤×’×™×©×•×ª ×§×¨×•×‘×•×ª (${upcomingAppointments})</h3>
                        ${upcomingAppointments > 0 ? `
                            <div class="space-y-2">
                                ${allAppointments
                                    .filter(a => new Date(a.date) >= new Date())
                                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                                    .slice(0, 3)
                                    .map(a => {
                                        const car = allCars.find(c => c.id === a.carId);
                                        return `
                                            <div class="flex justify-between items-center">
                                                <span class="font-semibold">${car ? car.carNumber : '×¨×›×‘ ×œ× ×™×“×•×¢'}</span>
                                                <span class="text-sm text-gray-600">${new Date(a.date).toLocaleDateString('he-IL')} ${a.time}</span>
                                            </div>
                                        `;
                                    }).join('')}
                            </div>
                        ` : '<p class="text-gray-500 text-center py-4">××™×Ÿ ×¤×’×™×©×•×ª ×§×¨×•×‘×•×ª</p>'}
                    </div>
                </div>
            `;
            
            document.getElementById('dashboardContent').innerHTML = content;
            document.getElementById('dashboardModal').classList.remove('hidden');
        }

        function closeDashboard() {
            document.getElementById('dashboardModal').classList.add('hidden');
        }

        // ==========================================
        // WhatsApp Integration
        // ==========================================
        
        function sendWhatsApp(phone, name) {
            // Remove any non-digit characters from phone
            const cleanPhone = phone.replace(/\D/g, '');
            
            // Add country code if not present
            const phoneWithCode = cleanPhone.startsWith('972') ? cleanPhone : '972' + cleanPhone.replace(/^0/, '');
            
            const message = `×©×œ×•× ${name}, ××•×¡×š [×©× ×”××•×¡×š] ×¤×•× ×” ××œ×™×š ×‘× ×•×’×¢ ×œ×¨×›×‘×š.`;
            const whatsappUrl = `https://wa.me/${phoneWithCode}?text=${encodeURIComponent(message)}`;
            
            window.open(whatsappUrl, '_blank');
        }

        // ==========================================
        // Backup & Restore
        // ==========================================
        
        async function handleBackup() {
            const choice = confirm('×œ×—×¥ OK ×œ×™×¦×™×¨×ª ×’×™×‘×•×™, ××• Cancel ×œ×©×—×–×•×¨ ×’×™×‘×•×™');
            
            if (choice) {
                await createBackup();
            } else {
                document.getElementById('restoreFileInput').click();
            }
        }

        async function createBackup() {
            try {
                showBackupProgress(true);
                updateBackupProgress(20, '××•×¡×£ × ×ª×•× ×™×...');
                
                const backupData = {
                    version: '1.0',
                    created: new Date().toISOString(),
                    cars: allCars,
                    maintenance: allMaintenance.map(m => ({
                        ...m,
                        createdAt: m.createdAt?.toMillis(),
                        updatedAt: m.updatedAt?.toMillis()
                    })),
                    appointments: allAppointments.map(a => ({
                        ...a,
                        createdAt: a.createdAt?.toMillis()
                    }))
                };
                
                updateBackupProgress(60, '×™×•×¦×¨ ×§×•×‘×¥ ×’×™×‘×•×™...');
                
                // Get user settings if exist
                try {
                    const settingsDoc = await db.collection('settings').doc(currentUser.uid).get();
                    if (settingsDoc.exists) {
                        backupData.settings = settingsDoc.data();
                    }
                } catch (error) {
                    console.log('No settings to backup');
                }
                
                updateBackupProgress(80, '×©×•××¨ ×§×•×‘×¥...');
                
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `garage_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                updateBackupProgress(100, '×”×’×™×‘×•×™ ×”×•×©×œ×!');
                setTimeout(() => {
                    showBackupProgress(false);
                    alert('×”×’×™×‘×•×™ × ×•×¦×¨ ×‘×”×¦×œ×—×”!');
                }, 1000);
                
            } catch (error) {
                console.error('Error creating backup:', error);
                alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×’×™×‘×•×™');
                showBackupProgress(false);
            }
        }

        function showBackupProgress(show) {
            const modal = document.getElementById('backupProgressModal');
            if (show) {
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }

        function updateBackupProgress(percent, text) {
            document.getElementById('backupProgressBar').style.width = percent + '%';
            document.getElementById('backupProgressText').textContent = text;
        }

        async function handleRestoreFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!confirm('×”×× ××ª×” ×‘×˜×•×—? ×–×” ×™××—×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×”× ×•×›×—×™×™×!')) {
                event.target.value = '';
                return;
            }
            
            try {
                const text = await file.text();
                const backupData = JSON.parse(text);
                
                // Validate backup
                if (!backupData.version || !backupData.cars) {
                    throw new Error('×§×•×‘×¥ ×’×™×‘×•×™ ×œ× ×ª×§×™×Ÿ');
                }
                
                showBackupProgress(true);
                updateBackupProgress(10, '××•×—×§ × ×ª×•× ×™× ×™×©× ×™×...');
                
                // Delete existing data
                await deleteAllUserData();
                
                updateBackupProgress(30, '××©×—×–×¨ ×¨×›×‘×™×...');
                // Restore cars
                for (const car of backupData.cars) {
                    const carData = { ...car };
                    delete carData.id;
                    await db.collection('cars').add(carData);
                }
                
                updateBackupProgress(50, '××©×—×–×¨ ×˜×™×¤×•×œ×™×...');
                // Restore maintenance
                for (const maintenance of backupData.maintenance) {
                    const maintenanceData = { ...maintenance };
                    delete maintenanceData.id;
                    
                    // Convert timestamps back
                    if (maintenanceData.createdAt) {
                        maintenanceData.createdAt = firebase.firestore.Timestamp.fromMillis(maintenanceData.createdAt);
                    }
                    if (maintenanceData.updatedAt) {
                        maintenanceData.updatedAt = firebase.firestore.Timestamp.fromMillis(maintenanceData.updatedAt);
                    }
                    
                    await db.collection('maintenance').add(maintenanceData);
                }
                
                updateBackupProgress(70, '××©×—×–×¨ ×¤×’×™×©×•×ª...');
                // Restore appointments
                for (const appointment of backupData.appointments) {
                    const appointmentData = { ...appointment };
                    delete appointmentData.id;
                    
                    if (appointmentData.createdAt) {
                        appointmentData.createdAt = firebase.firestore.Timestamp.fromMillis(appointmentData.createdAt);
                    }
                    
                    await db.collection('appointments').add(appointmentData);
                }
                
                updateBackupProgress(90, '××©×—×–×¨ ×”×’×“×¨×•×ª...');
                // Restore settings
                if (backupData.settings) {
                    await db.collection('settings').doc(currentUser.uid).set(backupData.settings);
                }
                
                updateBackupProgress(100, '×”×©×—×–×•×¨ ×”×•×©×œ×!');
                setTimeout(() => {
                    showBackupProgress(false);
                    alert('×”×©×—×–×•×¨ ×”×•×©×œ× ×‘×”×¦×œ×—×”! ×”×“×£ ×™×ª×¨×¢× ×Ÿ ×›×¢×ª.');
                    window.location.reload();
                }, 1000);
                
            } catch (error) {
                console.error('Error restoring backup:', error);
                alert('×©×’×™××” ×‘×©×—×–×•×¨ ×’×™×‘×•×™: ' + error.message);
                showBackupProgress(false);
            }
            
            event.target.value = '';
        }

        async function deleteAllUserData() {
            // Delete cars
            const carsSnapshot = await db.collection('cars')
                .where('userId', '==', currentUser.uid)
                .get();
            
            const deletePromises = [];
            carsSnapshot.forEach(doc => {
                deletePromises.push(db.collection('cars').doc(doc.id).delete());
            });
            
            // Delete maintenance
            const maintenanceSnapshot = await db.collection('maintenance')
                .where('userId', '==', currentUser.uid)
                .get();
            
            maintenanceSnapshot.forEach(doc => {
                deletePromises.push(db.collection('maintenance').doc(doc.id).delete());
            });
            
            // Delete appointments
            const appointmentsSnapshot = await db.collection('appointments')
                .where('userId', '==', currentUser.uid)
                .get();
            
            appointmentsSnapshot.forEach(doc => {
                deletePromises.push(db.collection('appointments').doc(doc.id).delete());
            });
            
            await Promise.all(deletePromises);
        }

        // ==========================================
        // Browser Back Button Support for Mobile
        // ==========================================
        
        // Handle browser back button
        window.addEventListener('popstate', function(event) {
            const carModal = document.getElementById('carModal');
            const detailsModal = document.getElementById('carDetailsModal');
            const maintenanceModal = document.getElementById('maintenanceModal');
            const calendarModal = document.getElementById('calendarModal');
            const appointmentModal = document.getElementById('appointmentModal');
            const dashboardModal = document.getElementById('dashboardModal');
            
            // Close any open modal when back button is pressed
            if (dashboardModal && !dashboardModal.classList.contains('hidden')) {
                closeDashboard();
            } else if (appointmentModal && !appointmentModal.classList.contains('hidden')) {
                closeAppointmentModal();
            } else if (calendarModal && !calendarModal.classList.contains('hidden')) {
                closeCalendarModal();
            } else if (carModal && !carModal.classList.contains('hidden')) {
                closeCarModal();
            } else if (maintenanceModal && !maintenanceModal.classList.contains('hidden')) {
                closeMaintenanceModal();
            } else if (detailsModal && !detailsModal.classList.contains('hidden')) {
                closeCarDetailsModal();
            }
        });

        // Wrap modal open functions to add history state
        (function() {
            // Save original functions
            const _openCarModal = window.openCarModal;
            const _openCarDetailsModal = window.openCarDetailsModal;
            const _openMaintenanceModal = window.openMaintenanceModal;
            const _openCalendarModal = window.openCalendarModal;
            const _openAppointmentModal = window.openAppointmentModal;
            const _openDashboard = window.openDashboard;
            
            // Override openCarModal
            window.openCarModal = function() {
                _openCarModal();
                history.pushState({ modal: 'car' }, '', '');
            };
            
            // Override openCarDetailsModal
            window.openCarDetailsModal = function(carId) {
                _openCarDetailsModal(carId);
                history.pushState({ modal: 'details' }, '', '');
            };
            
            // Override openMaintenanceModal
            window.openMaintenanceModal = function() {
                _openMaintenanceModal();
                history.pushState({ modal: 'maintenance' }, '', '');
            };
            
            // Override openCalendarModal
            window.openCalendarModal = function() {
                _openCalendarModal();
                history.pushState({ modal: 'calendar' }, '', '');
            };
            
            // Override openAppointmentModal
            window.openAppointmentModal = function() {
                _openAppointmentModal();
                history.pushState({ modal: 'appointment' }, '', '');
            };
            
            // Override openDashboard
            window.openDashboard = function() {
                _openDashboard();
                history.pushState({ modal: 'dashboard' }, '', '');
            };
        })();

        // Initialize theme on load
        initTheme();
    </script>

</body>
</html>
