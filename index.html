<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>××¢×¨×›×ª × ×™×”×•×œ ××•×¡×š</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase v9 Compatible Mode -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <style>
    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Loading -->
  <div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
    <div class="text-center">
      <div class="loader mx-auto mb-4"></div>
      <p class="text-gray-600">×˜×•×¢×Ÿ ××¢×¨×›×ª...</p>
    </div>
  </div>

  <!-- Login Screen -->
  <div id="loginScreen" class="hidden fixed inset-0 bg-blue-50 z-40 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl p-6 sm:p-8 max-w-md w-full">
      <h1 class="text-2xl font-bold text-center mb-6">××¢×¨×›×ª × ×™×”×•×œ ××•×¡×š</h1>

      <div id="errorMsg" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
      <div id="successMsg" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4"></div>

      <form id="loginForm">
        <div class="mb-4">
          <label class="block text-gray-700 mb-2">××™××™×™×œ</label>
          <input type="email" id="email" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
        </div>
        <div class="mb-6">
          <label class="block text-gray-700 mb-2">×¡×™×¡××”</label>
          <input type="password" id="password" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
        </div>
        <button type="submit" id="authBtn" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">×”×ª×—×‘×¨</button>
      </form>

      <p class="text-center mt-4">
        <a href="#" id="toggleAuth" class="text-blue-600 hover:underline">××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ? ×”×™×¨×©×</a>
      </p>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainApp" class="hidden container mx-auto px-3 sm:px-4 py-8">
    <div class="bg-white rounded-lg shadow p-4 sm:p-6 mb-6">
      <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-2 sm:gap-0">
        <h1 class="text-2xl font-bold text-center sm:text-left">××¢×¨×›×ª × ×™×”×•×œ ××•×¡×š</h1>
        <button onclick="signOut()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 w-full sm:w-auto">×™×¦×™××”</button>
      </div>

      <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 mb-4">
        <button onclick="openCarModal()" class="w-full sm:w-auto bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ ×”×•×¡×£ ×¨×›×‘</button>
        <button onclick="exportCSV()" class="w-full sm:w-auto bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">×™×™×¦× × ×ª×•× ×™×</button>
      </div>

      <input type="text" id="searchBox" placeholder="×—×™×¤×•×©..." onkeyup="searchCars()" class="w-full px-3 py-2 border rounded-lg">
    </div>

    <div id="carsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

    <div id="emptyState" class="text-center py-12 hidden">
      <p class="text-gray-500 text-xl">××™×Ÿ ×¨×›×‘×™× ×‘××¢×¨×›×ª</p>
      <button onclick="openCarModal()" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">×”×•×¡×£ ×¨×›×‘ ×¨××©×•×Ÿ</button>
    </div>
  </div>

 <!-- Car Modal -->
<div id="carModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 overflow-y-auto">
  <div class="bg-white rounded-lg p-4 sm:p-6 max-w-sm sm:max-w-md w-full max-h-[90vh] overflow-y-auto">
    <h2 id="modalTitle" class="text-xl font-bold mb-4">×”×•×¡×£ ×¨×›×‘</h2>

    <form id="carForm">
      <div class="mb-3">
        <label class="block text-gray-700 mb-1">××¡×¤×¨ ×¨×™×©×•×™ *</label>
        <input type="text" id="plateNumber" required class="w-full px-3 py-2 border rounded">
      </div>

      <div class="mb-3">
        <label class="block text-gray-700 mb-1">×©× ×”×‘×¢×œ×™× *</label>
        <input type="text" id="ownerName" required class="w-full px-3 py-2 border rounded">
      </div>

      <div class="mb-3">
        <label class="block text-gray-700 mb-1">×˜×œ×¤×•×Ÿ</label>
        <input type="text" id="phone" class="w-full px-3 py-2 border rounded">
      </div>

      <div class="mb-3">
        <label class="block text-gray-700 mb-1">×¡×•×’ ×¨×›×‘</label>
        <input type="text" id="carType" class="w-full px-3 py-2 border rounded">
      </div>

      <div class="mb-3">
        <label class="block text-gray-700 mb-1">×“×’×</label>
        <input type="text" id="model" class="w-full px-3 py-2 border rounded">
      </div>

      <div class="mb-3">
        <label class="block text-gray-700 mb-1">×©× ×”</label>
        <input type="text" id="year" class="w-full px-3 py-2 border rounded">
      </div>

      <div class="mb-3">
        <label class="block text-gray-700 mb-1">×ª××•× ×”</label>
        <input type="file" id="carImage" accept="image/*" class="w-full">
        <div id="imagePreview" class="mt-2"></div>
        <p class="text-xs text-gray-500 mt-1">××™×Ÿ ××’×‘×œ×ª ×’×•×“×œ | ×¤×•×¨××˜: JPG, PNG</p>
      </div>

      <div class="flex flex-col sm:flex-row gap-2 mt-4">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full sm:w-auto">
          ×©××•×¨
        </button>
        <button type="button" onclick="closeCarModal()" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500 w-full sm:w-auto">
          ×‘×™×˜×•×œ
        </button>
      </div>
    </form>
  </div>
</div>

  <script>
    // Firebase Configuration (Ù†ÙØ³ Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙƒ)
    const firebaseConfig = {
      apiKey: "AIzaSyCdSRfJCoU6xwDych3l_3K_hBZBHOi9jVg",
      authDomain: "garage-17263.firebaseapp.com",
      projectId: "garage-17263",
      storageBucket: "garage-17263.firebasestorage.app",
      messagingSenderId: "332265903935",
      appId: "1:332265903935:web:237c0787a161fd36a7a58a",
      measurementId: "G-KLLCPECCDQ"
    };

    let app, db, auth, storage;
    let currentUser = null;
    let cars = [];
    let editingCarId = null;
    let isRegisterMode = false;

    app = firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    auth = firebase.auth();
    storage = firebase.storage();

    // Auth observer
    auth.onAuthStateChanged(async (user) => {
      document.getElementById('loadingScreen').classList.add('hidden');
      if (user) {
        currentUser = user;
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        await loadCars();
      } else {
        currentUser = null;
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
      }
    });

    document.getElementById('toggleAuth').addEventListener('click', (e) => {
      e.preventDefault();
      isRegisterMode = !isRegisterMode;
      const authBtn = document.getElementById('authBtn');
      const toggleLink = document.getElementById('toggleAuth');
      authBtn.textContent = isRegisterMode ? '×”×™×¨×©×' : '×”×ª×—×‘×¨';
      toggleLink.textContent = isRegisterMode ? '×™×© ×œ×š ×—×©×‘×•×Ÿ? ×”×ª×—×‘×¨' : '××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ? ×”×™×¨×©×';
    });

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const btn = document.getElementById('authBtn');
      btn.disabled = true; btn.textContent = '××¢×‘×“...';
      try {
        if (isRegisterMode)
          await auth.createUserWithEmailAndPassword(email, password);
        else
          await auth.signInWithEmailAndPassword(email, password);
      } catch (err) {
        alert('×©×’×™××”: ' + err.message);
      } finally {
        btn.disabled = false; btn.textContent = isRegisterMode ? '×”×™×¨×©×' : '×”×ª×—×‘×¨';
      }
    });

    async function loadCars() {
      const snapshot = await db.collection('cars').where('userId', '==', currentUser.uid).get();
      cars = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      displayCars();
    }

    function displayCars() {
      const grid = document.getElementById('carsGrid');
      const empty = document.getElementById('emptyState');
      if (!cars.length) {
        grid.innerHTML = ''; empty.classList.remove('hidden'); return;
      }
      empty.classList.add('hidden');
      grid.innerHTML = cars.map(car => `
        <div class="bg-white rounded-lg shadow p-4 car-card" data-search="${car.plateNumber} ${car.ownerName}">
          ${car.imageUrl ? `<img src="${car.imageUrl}" class="w-full h-40 object-cover rounded mb-3">` :
          '<div class="w-full h-40 bg-gray-200 rounded mb-3 flex items-center justify-center text-gray-400">××™×Ÿ ×ª××•× ×”</div>'}
          <h3 class="font-bold text-lg">${car.plateNumber}</h3>
          <p class="text-gray-600">${car.ownerName}</p>
          ${car.phone ? `<p class="text-sm">ğŸ“ ${car.phone}</p>` : ''}
          ${car.carType ? `<p class="text-sm">ğŸš— ${car.carType}</p>` : ''}
          ${car.model ? `<p class="text-sm">ğŸ“‹ ${car.model}</p>` : ''}
          ${car.year ? `<p class="text-sm">ğŸ“… ${car.year}</p>` : ''}
          <div class="mt-3 flex gap-2">
            <button onclick="editCar('${car.id}')" class="text-blue-600 hover:underline">×¢×¨×™×›×”</button>
            <button onclick="deleteCar('${car.id}')" class="text-red-600 hover:underline">××—×™×§×”</button>
          </div>
        </div>
      `).join('');
    }

    function openCarModal() {
      editingCarId = null;
      document.getElementById('modalTitle').textContent = '×”×•×¡×£ ×¨×›×‘';
      document.getElementById('carForm').reset();
      document.getElementById('imagePreview').innerHTML = '';
      document.getElementById('carModal').classList.remove('hidden');
    }

    function closeCarModal() {
      document.getElementById('carModal').classList.add('hidden');
      editingCarId = null;
    }

    async function uploadImageToFirebase(file) {
      const fileName = `${Date.now()}_${file.name.replace(/\s/g, '_')}`;
      const storageRef = storage.ref().child(`cars/${currentUser.uid}/${fileName}`);
      const snapshot = await storageRef.put(file);
      return await snapshot.ref.getDownloadURL();
    }

    document.getElementById('carForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '×©×•××¨...';
      try {
        const carData = {
          plateNumber: plateNumber.value.trim(),
          ownerName: ownerName.value.trim(),
          phone: phone.value.trim(),
          carType: carType.value.trim(),
          model: model.value.trim(),
          year: year.value.trim(),
          userId: currentUser.uid,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        const imageFile = document.getElementById('carImage').files[0];
        if (imageFile) {
          carData.imageUrl = await uploadImageToFirebase(imageFile);
        } else if (editingCarId) {
          const existing = cars.find(c => c.id === editingCarId);
          if (existing?.imageUrl) carData.imageUrl = existing.imageUrl;
        }

        if (editingCarId) {
          await db.collection('cars').doc(editingCarId).update(carData);
          alert('×”×¨×›×‘ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!');
        } else {
          carData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('cars').add(carData);
          alert('×”×¨×›×‘ × ×•×¡×£ ×‘×”×¦×œ×—×”!');
        }

        closeCarModal();
        await loadCars();
      } catch (err) {
        alert('×©×’×™××”: ' + err.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = '×©××•×¨';
      }
    });

    async function deleteCar(carId) {
      if (!confirm('×”×× ×œ××—×•×§ ××ª ×”×¨×›×‘?')) return;
      await db.collection('cars').doc(carId).delete();
      alert('×”×¨×›×‘ × ××—×§ ×‘×”×¦×œ×—×”');
      await loadCars();
    }

    function searchCars() {
      const searchTerm = searchBox.value.toLowerCase();
      document.querySelectorAll('.car-card').forEach(c => {
        const t = c.dataset.search.toLowerCase();
        c.style.display = t.includes(searchTerm) ? 'block' : 'none';
      });
    }

    function exportCSV() {
      if (!cars.length) return alert('××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•×');
      let csv = '××¡×¤×¨ ×¨×™×©×•×™,×©× ×‘×¢×œ×™×,×˜×œ×¤×•×Ÿ,×¡×•×’,×“×’×,×©× ×”\n';
      cars.forEach(c => csv += `${c.plateNumber},${c.ownerName},${c.phone||''},${c.carType||''},${c.model||''},${c.year||''}\n`);
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `cars_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }

    async function signOut() {
      if (confirm('×”×× ×œ×¦××ª ××”××¢×¨×›×ª?')) await auth.signOut();
    }

    document.getElementById('carImage').addEventListener('change', (e) => {
      const file = e.target.files[0];
      const preview = document.getElementById('imagePreview');
      if (!file) return preview.innerHTML = '';
      const reader = new FileReader();
      reader.onload = ev => {
        preview.innerHTML = `
          <img src="${ev.target.result}" class="w-32 h-32 object-cover rounded mt-2 border">
          <p class="text-xs text-green-600 mt-1">âœ“ ×”×ª××•× ×” ××•×›× ×” ×œ×”×¢×œ××”</p>
        `;
      };
      reader.readAsDataURL(file);
    });
  </script>
</body>
</html>

