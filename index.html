<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注专转  住</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase v9 Compatible Mode -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    
    <style>
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="loader mx-auto mb-4"></div>
            <p class="text-gray-600">注 注专转...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="hidden fixed inset-0 bg-blue-50 z-40 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
            <h1 class="text-2xl font-bold text-center mb-6">注专转  住</h1>
            
            <div id="errorMsg" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
            <div id="successMsg" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4"></div>
            
            <form id="loginForm">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2"></label>
                    <input type="email" id="email" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 mb-2">住住</label>
                    <input type="password" id="password" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                </div>
                
                <button type="submit" id="authBtn" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                    转专
                </button>
            </form>
            
            <p class="text-center mt-4">
                <a href="#" id="toggleAuth" class="text-blue-600 hover:underline">  砖? 专砖</a>
            </p>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-bold">注专转  住</h1>
                <button onclick="signOut()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    爪
                </button>
            </div>
            
            <div class="flex gap-4 mb-4">
                <button onclick="openCarModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    + 住祝 专
                </button>
                <button onclick="exportCSV()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                    爪 转
                </button>
            </div>
            
            <input type="text" id="searchBox" placeholder="驻砖..." onkeyup="searchCars()" 
                   class="w-full px-3 py-2 border rounded-lg">
        </div>

        <!-- Cars Grid -->
        <div id="carsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        
        <!-- Empty State -->
        <div id="emptyState" class="text-center py-12 hidden">
            <p class="text-gray-500 text-xl"> 专 注专转</p>
            <button onclick="openCarModal()" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                住祝 专 专砖
            </button>
        </div>
    </div>

    <!-- Car Modal -->
    <div id="carModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 max-w-md w-full">
            <h2 id="modalTitle" class="text-xl font-bold mb-4">住祝 专</h2>
            
            <form id="carForm">
                <div class="mb-3">
                    <label class="block text-gray-700 mb-1">住驻专 专砖 *</label>
                    <input type="text" id="plateNumber" required class="w-full px-3 py-2 border rounded">
                </div>
                
                <div class="mb-3">
                    <label class="block text-gray-700 mb-1">砖 注 *</label>
                    <input type="text" id="ownerName" required class="w-full px-3 py-2 border rounded">
                </div>
                
                <div class="mb-3">
                    <label class="block text-gray-700 mb-1">驻</label>
                    <input type="text" id="phone" class="w-full px-3 py-2 border rounded">
                </div>
                
                <div class="mb-3">
                    <label class="block text-gray-700 mb-1">住 专</label>
                    <input type="text" id="carType" class="w-full px-3 py-2 border rounded">
                </div>
                
                <div class="mb-3">
                    <label class="block text-gray-700 mb-1"></label>
                    <input type="text" id="model" class="w-full px-3 py-2 border rounded">
                </div>
                
                <div class="mb-3">
                    <label class="block text-gray-700 mb-1">砖</label>
                    <input type="text" id="year" class="w-full px-3 py-2 border rounded">
                </div>
                
                <div class="mb-3">
                    <label class="block text-gray-700 mb-1">转</label>
                    <input type="file" id="carImage" accept="image/*" class="w-full">
                    <div id="imagePreview" class="mt-2"></div>
                </div>
                
                <div class="flex gap-2">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        砖专
                    </button>
                    <button type="button" onclick="closeCarModal()" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">
                        
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Firebase Configuration - Your Settings
        const firebaseConfig = {
            apiKey: "AIzaSyCdSRfJCoU6xwDych3l_3K_hBZBHOi9jVg",
            authDomain: "garage-17263.firebaseapp.com",
            projectId: "garage-17263",
            storageBucket: "garage-17263.firebasestorage.app",
            messagingSenderId: "332265903935",
            appId: "1:332265903935:web:237c0787a161fd36a7a58a",
            measurementId: "G-KLLCPECCDQ"
        };

        // Initialize Firebase
        let app, db, auth, storage;
        let currentUser = null;
        let cars = [];
        let editingCarId = null;
        let isRegisterMode = false;

        try {
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            storage = firebase.storage();
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            document.getElementById('loadingScreen').innerHTML = 
                '<div class="text-center"><p class="text-red-600">砖 注转 注专转</p></div>';
        }

        // Auth State Observer
        auth.onAuthStateChanged((user) => {
            console.log('Auth state changed:', user ? 'User logged in' : 'No user');
            
            if (user) {
                currentUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                loadCars();
            } else {
                currentUser = null;
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
            
            document.getElementById('loadingScreen').classList.add('hidden');
        });

        // Toggle Auth Mode
        document.getElementById('toggleAuth').addEventListener('click', (e) => {
            e.preventDefault();
            isRegisterMode = !isRegisterMode;
            const authBtn = document.getElementById('authBtn');
            const toggleLink = document.getElementById('toggleAuth');
            
            if (isRegisterMode) {
                authBtn.textContent = '专砖';
                toggleLink.textContent = '砖  砖? 转专';
            } else {
                authBtn.textContent = '转专';
                toggleLink.textContent = '  砖? 专砖';
            }
        });

        // Login/Register Form
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const authBtn = document.getElementById('authBtn');
            
            authBtn.disabled = true;
            authBtn.textContent = '注...';
            
            try {
                if (isRegisterMode) {
                    await auth.createUserWithEmailAndPassword(email, password);
                    showMessage('砖 爪专 爪!', 'success');
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                    showMessage('转专转 爪!', 'success');
                }
            } catch (error) {
                console.error('Auth error:', error);
                let message = '砖';
                
                switch(error.code) {
                    case 'auth/user-not-found':
                        message = '砖转砖  拽';
                        break;
                    case 'auth/wrong-password':
                        message = '住住 砖';
                        break;
                    case 'auth/email-already-in-use':
                        message = ' 专 砖砖';
                        break;
                    case 'auth/weak-password':
                        message = '住住 砖 ';
                        break;
                    case 'auth/invalid-email':
                        message = '  转拽';
                        break;
                }
                
                showMessage(message, 'error');
            } finally {
                authBtn.disabled = false;
                authBtn.textContent = isRegisterMode ? '专砖' : '转专';
            }
        });

        // Load Cars
        async function loadCars() {
            try {
                const snapshot = await db.collection('cars')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                cars = [];
                snapshot.forEach(doc => {
                    cars.push({ id: doc.id, ...doc.data() });
                });
                
                displayCars();
            } catch (error) {
                console.error('Error loading cars:', error);
            }
        }

        // Display Cars
        function displayCars() {
            const grid = document.getElementById('carsGrid');
            const emptyState = document.getElementById('emptyState');
            
            if (cars.length === 0) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            grid.innerHTML = cars.map(car => `
                <div class="bg-white rounded-lg shadow p-4 car-card" data-search="${car.plateNumber} ${car.ownerName}">
                    ${car.imageUrl ? 
                        `<img src="${car.imageUrl}" class="w-full h-40 object-cover rounded mb-3">` : 
                        '<div class="w-full h-40 bg-gray-200 rounded mb-3 flex items-center justify-center text-gray-400"> 转</div>'
                    }
                    <h3 class="font-bold text-lg">${car.plateNumber}</h3>
                    <p class="text-gray-600">${car.ownerName}</p>
                    ${car.phone ? `<p class="text-sm"> ${car.phone}</p>` : ''}
                    ${car.carType ? `<p class="text-sm"> ${car.carType}</p>` : ''}
                    ${car.model ? `<p class="text-sm"> ${car.model}</p>` : ''}
                    ${car.year ? `<p class="text-sm"> ${car.year}</p>` : ''}
                    
                    <div class="mt-3 flex gap-2">
                        <button onclick="editCar('${car.id}')" class="text-blue-600 hover:underline">注专</button>
                        <button onclick="deleteCar('${car.id}')" class="text-red-600 hover:underline">拽</button>
                    </div>
                </div>
            `).join('');
        }

        // Open Car Modal
        function openCarModal() {
            editingCarId = null;
            document.getElementById('modalTitle').textContent = '住祝 专';
            document.getElementById('carForm').reset();
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('carModal').classList.remove('hidden');
        }

        // Close Car Modal
        function closeCarModal() {
            document.getElementById('carModal').classList.add('hidden');
            editingCarId = null;
        }

        // Edit Car
        function editCar(carId) {
            const car = cars.find(c => c.id === carId);
            if (!car) return;
            
            editingCarId = carId;
            document.getElementById('modalTitle').textContent = '注专 专';
            document.getElementById('plateNumber').value = car.plateNumber || '';
            document.getElementById('ownerName').value = car.ownerName || '';
            document.getElementById('phone').value = car.phone || '';
            document.getElementById('carType').value = car.carType || '';
            document.getElementById('model').value = car.model || '';
            document.getElementById('year').value = car.year || '';
            
            if (car.imageUrl) {
                document.getElementById('imagePreview').innerHTML = 
                    `<img src="${car.imageUrl}" class="w-32 h-32 object-cover rounded">`;
            }
            
            document.getElementById('carModal').classList.remove('hidden');
        }

        // Car Form Submit
        document.getElementById('carForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = '砖专...';
            
            const carData = {
                plateNumber: document.getElementById('plateNumber').value,
                ownerName: document.getElementById('ownerName').value,
                phone: document.getElementById('phone').value,
                carType: document.getElementById('carType').value,
                model: document.getElementById('model').value,
                year: document.getElementById('year').value,
                userId: currentUser.uid,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                // Handle image upload if exists
                const imageFile = document.getElementById('carImage').files[0];
                if (imageFile) {
                    // Check file size
                    if (imageFile.size > 5 * 1024 * 1024) {
                        alert('拽抓  .  拽住  5MB');
                        submitBtn.disabled = false;
                        submitBtn.textContent = '砖专';
                        return;
                    }
                    
                    try {
                        console.log('注 转...');
                        const fileName = `${Date.now()}_${imageFile.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                        const storageRef = storage.ref(`cars/${currentUser.uid}/${fileName}`);
                        
                        const uploadTask = await storageRef.put(imageFile);
                        const downloadURL = await uploadTask.ref.getDownloadURL();
                        carData.imageUrl = downloadURL;
                        console.log('转 注转 爪');
                    } catch (uploadError) {
                        console.error('砖 注转 转:', uploadError);
                        
                        // Ask user if they want to continue without image
                        if (!confirm(' 转 注转 转 转.  砖 注?')) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = '砖专';
                            return;
                        }
                    }
                } else if (editingCarId) {
                    // Keep existing image if editing and no new image selected
                    const existingCar = cars.find(c => c.id === editingCarId);
                    if (existingCar && existingCar.imageUrl) {
                        carData.imageUrl = existingCar.imageUrl;
                    }
                }
                
                if (editingCarId) {
                    await db.collection('cars').doc(editingCarId).update(carData);
                    alert('专 注 爪!');
                } else {
                    carData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('cars').add(carData);
                    alert('专 住祝 爪!');
                }
                
                closeCarModal();
                loadCars();
            } catch (error) {
                console.error('砖 砖专转 专:', error);
                alert('砖 砖专转 转.  住 砖.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '砖专';
            }
        });

        // Delete Car
        async function deleteCar(carId) {
            if (!confirm(' 拽 转 专?')) return;
            
            try {
                // Get car data to delete image if exists
                const car = cars.find(c => c.id === carId);
                
                // Delete image from storage if exists
                if (car && car.imageUrl) {
                    try {
                        const imageRef = storage.refFromURL(car.imageUrl);
                        await imageRef.delete();
                        console.log('转 拽 住');
                    } catch (imgError) {
                        console.error('砖 拽转 转:', imgError);
                        // Continue even if image deletion fails
                    }
                }
                
                // Delete car document
                await db.collection('cars').doc(carId).delete();
                alert('专 拽 爪');
                loadCars();
            } catch (error) {
                console.error('砖 拽转 专:', error);
                alert('砖 拽转 专');
            }
        }

        // Search Cars
        function searchCars() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const cards = document.querySelectorAll('.car-card');
            
            cards.forEach(card => {
                const text = card.dataset.search.toLowerCase();
                card.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        // Export CSV
        function exportCSV() {
            if (cars.length === 0) {
                alert(' 转 爪');
                return;
            }
            
            let csv = '住驻专 专砖,砖 注,驻,住,,砖\n';
            cars.forEach(car => {
                csv += `${car.plateNumber},${car.ownerName},${car.phone || ''},${car.carType || ''},${car.model || ''},${car.year || ''}\n`;
            });
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `cars_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Sign Out
        async function signOut() {
            if (confirm(' 爪转 注专转?')) {
                await auth.signOut();
            }
        }

        // Show Message
        function showMessage(message, type) {
            const errorDiv = document.getElementById('errorMsg');
            const successDiv = document.getElementById('successMsg');
            
            if (type === 'error') {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
                successDiv.classList.add('hidden');
            } else {
                successDiv.textContent = message;
                successDiv.classList.remove('hidden');
                errorDiv.classList.add('hidden');
            }
            
            setTimeout(() => {
                errorDiv.classList.add('hidden');
                successDiv.classList.add('hidden');
            }, 5000);
        }

        // Image Preview with size check
        document.getElementById('carImage').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                // Check file size (5MB limit)
                if (file.size > 5 * 1024 * 1024) {
                    alert('转  .  拽住  5MB');
                    e.target.value = '';
                    document.getElementById('imagePreview').innerHTML = '';
                    return;
                }
                
                // Check file type
                if (!file.type.startsWith('image/')) {
                    alert(' 专 拽抓 转');
                    e.target.value = '';
                    document.getElementById('imagePreview').innerHTML = '';
                    return;
                }
                
                // Show preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('imagePreview').innerHTML = 
                        `<img src="${e.target.result}" class="w-32 h-32 object-cover rounded mt-2">
                         <p class="text-xs text-gray-500 mt-1">: ${(file.size / 1024 / 1024).toFixed(2)}MB</p>`;
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('imagePreview').innerHTML = '';
            }
        });
    </script>

</body>
</html>
