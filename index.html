<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Garage Manager</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <!-- Image Compression -->
  <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.min.js"></script>

  <style>
    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Loading Screen -->
  <div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
    <div class="text-center">
      <div class="loader mx-auto mb-4"></div>
      <p class="text-gray-600">×˜×•×¢×Ÿ ××¢×¨×›×ª...</p>
    </div>
  </div>

  <!-- Login Screen -->
  <div id="loginScreen" class="hidden fixed inset-0 bg-blue-50 z-40 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl p-6 sm:p-8 max-w-md w-full">
      <h1 class="text-2xl font-bold text-center mb-6">Garage Manager</h1>

      <form id="loginForm">
        <div class="mb-4">
          <label class="block text-gray-700 mb-2">××™××™×™×œ</label>
          <input type="email" id="email" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
        </div>
        <div class="mb-6">
          <label class="block text-gray-700 mb-2">×¡×™×¡××”</label>
          <input type="password" id="password" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
        </div>
        <button type="submit" id="authBtn" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">×”×ª×—×‘×¨</button>
      </form>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainApp" class="hidden container mx-auto px-4 py-6">

    <!-- Header -->
    <div class="bg-white rounded-lg shadow p-4 sm:p-6 mb-6 flex flex-col sm:flex-row items-center justify-between gap-3">
      <div class="flex items-center gap-2">
        <span class="text-3xl">ğŸš—</span>
        <h1 class="text-2xl font-bold text-blue-600">Garage Manager</h1>
      </div>
      <button onclick="signOut()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 w-full sm:w-auto">×™×¦×™××”</button>
    </div>

    <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 mb-4">
      <button onclick="openCarModal()" class="w-full sm:w-auto bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ ×”×•×¡×£ ×¨×›×‘</button>
      <button onclick="exportCSV()" class="w-full sm:w-auto bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">×™×™×¦× × ×ª×•× ×™×</button>
    </div>

    <input type="text" id="searchBox" placeholder="×—×™×¤×•×©..." onkeyup="searchCars()" class="w-full px-3 py-2 border rounded-lg mb-4">

    <div id="carsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    <div id="emptyState" class="text-center py-12 hidden">
      <p class="text-gray-500 text-xl">××™×Ÿ ×¨×›×‘×™× ×‘××¢×¨×›×ª</p>
      <button onclick="openCarModal()" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">×”×•×¡×£ ×¨×›×‘ ×¨××©×•×Ÿ</button>
    </div>
  </div>

  <!-- Car Modal -->
  <div id="carModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 overflow-y-auto">
    <div class="bg-white rounded-lg p-4 sm:p-6 max-w-sm sm:max-w-md w-full max-h-[90vh] overflow-y-auto relative">
      <button onclick="closeCarModal()" class="absolute top-2 right-3 text-gray-500 text-xl">Ã—</button>
      <h2 id="modalTitle" class="text-xl font-bold mb-4 text-center">×”×•×¡×£ ×¨×›×‘</h2>

      <form id="carForm">
        <div class="mb-3"><label class="block text-gray-700 mb-1">××¡×¤×¨ ×¨×™×©×•×™ *</label><input type="text" id="plateNumber" required class="w-full px-3 py-2 border rounded"></div>
        <div class="mb-3"><label class="block text-gray-700 mb-1">×©× ×”×‘×¢×œ×™× *</label><input type="text" id="ownerName" required class="w-full px-3 py-2 border rounded"></div>
        <div class="mb-3"><label class="block text-gray-700 mb-1">×˜×œ×¤×•×Ÿ</label><input type="text" id="phone" class="w-full px-3 py-2 border rounded"></div>
        <div class="mb-3"><label class="block text-gray-700 mb-1">×¡×•×’ ×¨×›×‘</label><input type="text" id="carType" class="w-full px-3 py-2 border rounded"></div>
        <div class="mb-3"><label class="block text-gray-700 mb-1">×“×’×</label><input type="text" id="model" class="w-full px-3 py-2 border rounded"></div>
        <div class="mb-3"><label class="block text-gray-700 mb-1">×©× ×”</label><input type="text" id="year" class="w-full px-3 py-2 border rounded"></div>
        <div class="mb-3">
          <label class="block text-gray-700 mb-1">×ª××•× ×”</label>
          <input type="file" id="carImage" accept="image/*" class="w-full">
          <div id="imagePreview" class="mt-2"></div>
          <p class="text-xs text-gray-500 mt-1">××™×Ÿ ××’×‘×œ×ª ×’×•×“×œ | ×¤×•×¨××˜: JPG, PNG</p>
        </div>
        <div class="flex flex-col sm:flex-row gap-2 mt-4 items-center">
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full sm:w-auto flex items-center justify-center gap-2">
            <span id="saveText">×©×•××¨...</span>
            <div id="uploadLoader" class="loader hidden"></div>
          </button>
          <button type="button" onclick="closeCarModal()" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500 w-full sm:w-auto">×‘×™×˜×•×œ</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCdSRfJCoU6xwDych3l_3K_hBZBHOi9jVg",
      authDomain: "garage-17263.firebaseapp.com",
      projectId: "garage-17263",
      storageBucket: "garage-17263.appspot.com", // âœ… ×ª×™×§×•×Ÿ ×—×©×•×‘
      messagingSenderId: "332265903935",
      appId: "1:332265903935:web:237c0787a161fd36a7a58a",
      measurementId: "G-KLLCPECCDQ"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    let cars = [], currentUser = null, editingCarId = null;

    auth.onAuthStateChanged(async (user) => {
      document.getElementById('loadingScreen').classList.add('hidden');
      if (user) {
        currentUser = user;
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        await loadCars();
      } else {
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
      }
    });

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = email.value, password = document.getElementById('password').value;
      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (err) { alert(err.message); }
    });

    async function loadCars() {
      const snapshot = await db.collection('cars').where('userId', '==', currentUser.uid).get();
      cars = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      displayCars();
    }

    function displayCars() {
      const grid = document.getElementById('carsGrid');
      const empty = document.getElementById('emptyState');
      if (!cars.length) {
        grid.innerHTML = ''; empty.classList.remove('hidden'); return;
      }
      empty.classList.add('hidden');
      grid.innerHTML = cars.map(car => `
        <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition p-4 car-card" data-search="${car.plateNumber} ${car.ownerName}">
          ${car.imageUrl ? `<img src="${car.imageUrl}" class="w-full h-40 object-cover rounded mb-3">` : '<div class="w-full h-40 bg-gray-200 rounded mb-3 flex items-center justify-center text-gray-400">××™×Ÿ ×ª××•× ×”</div>'}
          <h3 class="font-bold text-lg">${car.plateNumber}</h3>
          <p class="text-gray-600">${car.ownerName}</p>
          <div class="mt-3 flex gap-2">
            <button onclick="editCar('${car.id}')" class="text-blue-600 hover:underline">×¢×¨×™×›×”</button>
            <button onclick="deleteCar('${car.id}')" class="text-red-600 hover:underline">××—×™×§×”</button>
          </div>
        </div>`).join('');
    }

    function openCarModal() {
      editingCarId = null;
      document.getElementById('carForm').reset();
      document.getElementById('imagePreview').innerHTML = '';
      document.getElementById('carModal').classList.remove('hidden');
    }

    function closeCarModal() {
      document.getElementById('carModal').classList.add('hidden');
    }

    async function uploadCompressedImage(file) {
      const compressed = await imageCompression(file, { maxSizeMB: 2, maxWidthOrHeight: 1920, useWebWorker: true });
      const fileName = `${Date.now()}_${file.name.replace(/\s/g, '_')}`;
      const storageRef = storage.ref().child(`cars/${currentUser.uid}/${fileName}`);
      const snapshot = await storageRef.put(compressed);
      return await snapshot.ref.getDownloadURL();
    }

    document.getElementById('carForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const saveText = document.getElementById('saveText');
      const loader = document.getElementById('uploadLoader');
      saveText.textContent = "××¢×œ×”...";
      loader.classList.remove('hidden');
      try {
        const carData = {
          plateNumber: plateNumber.value.trim(),
          ownerName: ownerName.value.trim(),
          phone: phone.value.trim(),
          carType: carType.value.trim(),
          model: model.value.trim(),
          year: year.value.trim(),
          userId: currentUser.uid,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        const imageFile = document.getElementById('carImage').files[0];
        if (imageFile) carData.imageUrl = await uploadCompressedImage(imageFile);

        if (editingCarId) {
          await db.collection('cars').doc(editingCarId).update(carData);
          alert('×”×¨×›×‘ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!');
        } else {
          carData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('cars').add(carData);
          alert('×”×¨×›×‘ × ×•×¡×£ ×‘×”×¦×œ×—×”!');
        }
        closeCarModal(); await loadCars();
      } catch (err) { alert('×©×’×™××”: ' + err.message); }
      finally {
        loader.classList.add('hidden');
        saveText.textContent = "×©××•×¨";
      }
    });

    async function deleteCar(id) {
      if (!confirm('×”×× ×œ××—×•×§ ××ª ×”×¨×›×‘?')) return;
      await db.collection('cars').doc(id).delete();
      await loadCars();
    }

    function searchCars() {
      const search = searchBox.value.toLowerCase();
      document.querySelectorAll('.car-card').forEach(c => c.style.display = c.dataset.search.toLowerCase().includes(search) ? 'block' : 'none');
    }

    async function signOut() { await auth.signOut(); }
  </script>
</body>
</html>
