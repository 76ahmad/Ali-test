<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª × ×™×”×•×œ ××•×¡×š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .image-preview {
            position: relative;
            display: inline-block;
        }
        .image-preview img {
            object-fit: cover;
        }
        .delete-image-btn {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
        }
        .delete-image-btn:hover {
            background: rgba(220, 38, 38, 1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <div class="flex items-center justify-between mb-8 flex-wrap gap-4">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 p-3 rounded-xl">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/>
                            <circle cx="7" cy="17" r="2"/>
                            <path d="M9 17h6"/>
                            <circle cx="17" cy="17" r="2"/>
                        </svg>
                    </div>
                    <h1 class="text-4xl font-bold text-gray-800">××¢×¨×›×ª × ×™×”×•×œ ××•×¡×š</h1>
                </div>
                <div class="flex gap-3">
                    <button onclick="showAddCarForm()" class="flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        ×”×•×¡×£ ×¨×›×‘
                    </button>
                    <button onclick="exportToExcel()" class="flex items-center gap-2 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        ×™×™×¦× ×œ××§×¡×œ
                    </button>
                </div>
            </div>

            <div class="relative mb-6">
                <svg class="absolute right-4 top-3.5 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input type="text" id="searchInput" onkeyup="filterCars()" placeholder="×—×™×¤×•×© ×œ×¤×™ ××¡×¤×¨ ×¨×™×©×•×™ ××• ×©× ×‘×¢×œ×™×..." class="w-full pr-12 pl-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
            </div>

            <div class="mb-6">
                <label class="block text-gray-700 font-semibold mb-2">×¡×™× ×•×Ÿ ×œ×¤×™ ×¡×•×’ ×¨×›×‘</label>
                <select id="carTypeFilter" onchange="filterCars()" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                    <option value="">×›×œ ×”×¨×›×‘×™×</option>
                </select>
            </div>

            <div class="text-gray-600 mb-4">
                ×¡×š ×”×›×œ ×¨×›×‘×™×: <span id="carCount" class="font-bold text-blue-600">0</span>
            </div>
        </div>

        <!-- Cars Grid -->
        <div id="carsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

        <!-- Empty State -->
        <div id="emptyState" class="bg-white rounded-2xl shadow-xl p-12 text-center hidden">
            <svg class="mx-auto text-gray-400 mb-4" xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/>
                <circle cx="7" cy="17" r="2"/>
                <path d="M9 17h6"/>
                <circle cx="17" cy="17" r="2"/>
            </svg>
            <h3 class="text-2xl font-bold text-gray-600 mb-2">××™×Ÿ ×¨×›×‘×™× ×‘××¢×¨×›×ª</h3>
            <p class="text-gray-500">×”×ª×—×œ ×¢×œ ×™×“×™ ×”×•×¡×¤×ª ×¨×›×‘ ×—×“×©</p>
        </div>
    </div>

    <!-- Add/Edit Car Modal -->
    <div id="carModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <h2 id="carModalTitle" class="text-2xl font-bold mb-6 text-gray-800">×”×•×¡×¤×ª ×¨×›×‘ ×—×“×©</h2>
            
            <div class="mb-6">
                <label class="block text-gray-700 font-semibold mb-2">×ª××•× ×ª ×”×¨×›×‘</label>
                <input type="file" id="carImageInput" accept="image/*" onchange="handleCarImageUpload(event)" class="hidden">
                <div id="carImagePreview" class="mb-4"></div>
                <button onclick="document.getElementById('carImageInput').click()" class="flex items-center gap-2 bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                    ×”×¢×œ×” ×ª××•× ×”
                </button>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">××¡×¤×¨ ×¨×™×©×•×™ *</label>
                    <input type="text" id="plateNumber" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>
                
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">×©× ×”×‘×¢×œ×™× *</label>
                    <input type="text" id="ownerName" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>
                
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">××¡×¤×¨ ×˜×œ×¤×•×Ÿ</label>
                    <input type="text" id="phone" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>
                
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">×¡×•×’ ×¨×›×‘</label>
                    <input type="text" id="carType" list="carTypeSuggestions" placeholder="×˜×•×™×•×˜×”, ××¨×¦×“×¡, ×•×›×•'" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" onchange="handleCarTypeChange()" onblur="handleCarTypeChange()">
                    <datalist id="carTypeSuggestions"></datalist>
                </div>
                
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">×“×’×</label>
                    <input type="text" id="model" list="modelSuggestions" placeholder="×§×•×¨×•×œ×”, ××œ×˜×™××”, ×•×›×•'" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" onchange="handleModelChange()" onblur="handleModelChange()">
                    <datalist id="modelSuggestions"></datalist>
                    <p class="text-xs text-blue-600 mt-1">ğŸ’¡ ×‘×—×¨ ××”×¨×©×™××” ×œ××™×œ×•×™ ××•×˜×•××˜×™</p>
                </div>
                
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">×©× ×ª ×™×™×¦×•×¨</label>
                    <input type="text" id="year" placeholder="2020" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">×§×•×“ ×¨×›×‘ (VIN)</label>
                    <input type="text" id="carCode" placeholder="17 ×¡×¤×¨×•×ª" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">×¡×•×’ ×× ×•×¢</label>
                    <input type="text" id="engineType" placeholder="×‘× ×–×™×Ÿ, ×“×™×–×œ, ×”×™×‘×¨×™×“×™, ×—×©××œ×™" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">×”×¡×¤×§ ×× ×•×¢</label>
                    <input type="text" id="enginePower" placeholder="150 ×›×´×¡ / 2000 ×¡××´×§" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>
            </div>

            <div class="flex gap-3 justify-end">
                <button onclick="closeCarModal()" class="px-6 py-2 border-2 border-gray-300 rounded-lg hover:bg-gray-100 transition">
                    ×‘×™×˜×•×œ
                </button>
                <button onclick="saveCar()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    ×©××•×¨
                </button>
            </div>
        </div>
    </div>

    <!-- Car Details Modal -->
    <div id="detailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h2 id="detailsPlate" class="text-3xl font-bold text-gray-800 mb-2"></h2>
                    <p id="detailsOwner" class="text-xl text-gray-600"></p>
                </div>
                <button onclick="closeDetailsModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
                    Ã—
                </button>
            </div>

            <div id="detailsCarImage" class="mb-6"></div>

            <div id="detailsInfo" class="grid grid-cols-3 gap-4 mb-8 bg-gray-50 p-6 rounded-xl"></div>

            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">×”×™×¡×˜×•×¨×™×™×ª ×˜×™×¤×•×œ×™×</h3>
                <button onclick="showMaintenanceForm()" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    ×”×•×¡×£ ×˜×™×¤×•×œ
                </button>
            </div>

            <div id="maintenanceList"></div>
        </div>
    </div>

    <!-- Maintenance Modal -->
    <div id="maintenanceModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <h2 id="maintenanceModalTitle" class="text-2xl font-bold mb-6 text-gray-800">×”×•×¡×¤×ª ×˜×™×¤×•×œ</h2>
            
            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">×ª××¨×™×š *</label>
                    <input type="date" id="maintenanceDate" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>
                
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">×§×™×œ×•××˜×¨××–' *</label>
                    <input type="number" id="kilometers" placeholder="××¡×¤×¨ ×”×§×™×œ×•××˜×¨×™×" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>
                
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">×©× ×”×—×œ×§ *</label>
                    <input type="text" id="partName" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>
                
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">×ª×™××•×¨ ×”×¢×‘×•×“×”</label>
                    <textarea id="description" rows="3" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"></textarea>
                </div>
                
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">×¢×œ×•×ª (â‚ª) *</label>
                    <input type="number" id="cost" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">×ª××•× ×•×ª ×”×ª×§×œ×”</label>
                    <input type="file" id="maintenanceImagesInput" accept="image/*" multiple onchange="handleMaintenanceImagesUpload(event)" class="hidden">
                    <div id="maintenanceImagesPreview" class="mb-4 grid grid-cols-3 gap-2"></div>
                    <button type="button" onclick="document.getElementById('maintenanceImagesInput').click()" class="flex items-center gap-2 bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                        ×”×¢×œ×” ×ª××•× ×•×ª
                    </button>
                </div>
            </div>

            <div class="flex gap-3 justify-end">
                <button onclick="closeMaintenanceModal()" class="px-6 py-2 border-2 border-gray-300 rounded-lg hover:bg-gray-100 transition">
                    ×‘×™×˜×•×œ
                </button>
                <button onclick="saveMaintenance()" id="saveMaintenanceBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    ×”×•×¡×£ ×˜×™×¤×•×œ
                </button>
            </div>
        </div>
    </div>

    <!-- Image Viewer Modal -->
    <div id="imageViewerModal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-50" onclick="closeImageViewer()">
        <button onclick="closeImageViewer()" class="absolute top-4 left-4 text-white text-4xl hover:text-gray-300">Ã—</button>
        <img id="viewerImage" src="" alt="" class="max-w-full max-h-full object-contain" onclick="event.stopPropagation()">
    </div>

    <script>
        // Format phone number for WhatsApp (Israeli numbers)
        function formatPhoneForWhatsApp(phone) {
            if (!phone) return '';
            
            // Remove all non-digit characters
            let cleaned = phone.replace(/\D/g, '');
            
            // If starts with 0, remove it (Israeli local format)
            if (cleaned.startsWith('0')) {
                cleaned = cleaned.substring(1);
            }
            
            // If doesn't start with 972, add it
            if (!cleaned.startsWith('972')) {
                cleaned = '972' + cleaned;
            }
            
            return cleaned;
        }

        // Populate car type suggestions
        function populateCarTypeSuggestions() {
            const datalist = document.getElementById('carTypeSuggestions');
            datalist.innerHTML = Object.keys(carModelsDatabase).map(brand => 
                `<option value="${brand}">`
            ).join('');
        }

        // Handle car type change
        function handleCarTypeChange() {
            const carType = document.getElementById('carType').value.trim();
            const modelInput = document.getElementById('model');
            const datalist = document.getElementById('modelSuggestions');
            
            console.log('Car type changed:', carType);
            
            // Clear model suggestions
            datalist.innerHTML = '';
            
            // Find matching car type in database (case insensitive)
            const matchingBrand = Object.keys(carModelsDatabase).find(brand => 
                brand === carType || brand.toLowerCase() === carType.toLowerCase()
            );
            
            console.log('Matching brand:', matchingBrand);
            
            if (matchingBrand && carModelsDatabase[matchingBrand]) {
                const models = Object.keys(carModelsDatabase[matchingBrand].models);
                console.log('Available models:', models);
                datalist.innerHTML = models.map(model => 
                    `<option value="${model}">`
                ).join('');
            }
        }

        // Handle model change - auto-fill engine details
        function handleModelChange() {
            const carType = document.getElementById('carType').value.trim();
            const model = document.getElementById('model').value.trim();
            
            console.log('Model changed:', model, 'for car type:', carType);
            
            // Find matching brand (case insensitive)
            const matchingBrand = Object.keys(carModelsDatabase).find(brand => 
                brand === carType || brand.toLowerCase() === carType.toLowerCase()
            );
            
            console.log('Found brand:', matchingBrand);
            
            if (matchingBrand && carModelsDatabase[matchingBrand]) {
                const models = carModelsDatabase[matchingBrand].models;
                
                // Find matching model (case insensitive)
                const matchingModel = Object.keys(models).find(m => 
                    m === model || m.toLowerCase() === model.toLowerCase()
                );
                
                console.log('Found model:', matchingModel);
                
                if (matchingModel && models[matchingModel]) {
                    const modelData = models[matchingModel];
                    
                    console.log('Auto-filling:', modelData);
                    
                    // Auto-fill engine type and power
                    document.getElementById('engineType').value = modelData.engineType || '';
                    document.getElementById('enginePower').value = modelData.enginePower || '';
                    
                    // Show success message
                    const modelInput = document.getElementById('model');
                    modelInput.style.borderColor = '#10b981';
                    setTimeout(() => {
                        modelInput.style.borderColor = '';
                    }, 1000);
                }
            }
        }

        // Load data from localStorage
        function loadData() {
            const savedCars = localStorage.getItem('garageCars');
            if (savedCars) {
                cars = JSON.parse(savedCars);
            }
            updateCarTypeFilter();
            renderCars();
        }

        // Update car type filter options
        function updateCarTypeFilter() {
            const carTypes = [...new Set(cars.map(car => car.carType).filter(type => type && type.trim()))];
            const filterSelect = document.getElementById('carTypeFilter');
            
            filterSelect.innerHTML = '<option value="">×›×œ ×”×¨×›×‘×™×</option>' + 
                carTypes.sort().map(type => `<option value="${type}">${type}</option>`).join('');
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('garageCars', JSON.stringify(cars));
        }

        // Handle car image upload
        function handleCarImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    tempCarImage = e.target.result;
                    displayCarImagePreview();
                };
                reader.readAsDataURL(file);
            }
        }

        // Display car image preview
        function displayCarImagePreview() {
            const preview = document.getElementById('carImagePreview');
            if (tempCarImage) {
                preview.innerHTML = `
                    <div class="image-preview">
                        <img src="${tempCarImage}" alt="Car" class="w-full h-48 rounded-lg">
                        <span class="delete-image-btn" onclick="deleteCarImage()">Ã—</span>
                    </div>
                `;
            } else {
                preview.innerHTML = '';
            }
        }

        // Delete car image
        function deleteCarImage() {
            tempCarImage = null;
            displayCarImagePreview();
        }

        // Handle maintenance images upload
        function handleMaintenanceImagesUpload(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    tempMaintenanceImages.push(e.target.result);
                    displayMaintenanceImagesPreview();
                };
                reader.readAsDataURL(file);
            });
        }

        // Display maintenance images preview
        function displayMaintenanceImagesPreview() {
            const preview = document.getElementById('maintenanceImagesPreview');
            preview.innerHTML = tempMaintenanceImages.map((img, index) => `
                <div class="image-preview">
                    <img src="${img}" alt="Maintenance ${index + 1}" class="w-full h-24 rounded-lg cursor-pointer" onclick="viewImage('${img}')">
                    <span class="delete-image-btn" onclick="deleteMaintenanceImage(${index})">Ã—</span>
                </div>
            `).join('');
        }

        // Delete maintenance image
        function deleteMaintenanceImage(index) {
            tempMaintenanceImages.splice(index, 1);
            displayMaintenanceImagesPreview();
        }

        // View image in full screen
        function viewImage(src) {
            document.getElementById('viewerImage').src = src;
            document.getElementById('imageViewerModal').classList.remove('hidden');
        }

        // Close image viewer
        function closeImageViewer() {
            document.getElementById('imageViewerModal').classList.add('hidden');
        }

        // Render cars grid
        function renderCars() {
            const grid = document.getElementById('carsGrid');
            const emptyState = document.getElementById('emptyState');
            const carCount = document.getElementById('carCount');
            
            carCount.textContent = cars.length;
            
            if (cars.length === 0) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            grid.innerHTML = cars.map(car => `
                <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition car-card" data-plate="${car.plateNumber}" data-owner="${car.ownerName}">
                    ${car.image ? `
                        <img src="${car.image}" alt="${car.plateNumber}" class="w-full h-48 object-cover rounded-t-xl cursor-pointer" onclick="viewImage('${car.image}')">
                    ` : `
                        <div class="w-full h-48 bg-gray-200 rounded-t-xl flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400">
                                <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/>
                                <circle cx="7" cy="17" r="2"/>
                                <path d="M9 17h6"/>
                                <circle cx="17" cy="17" r="2"/>
                            </svg>
                        </div>
                    `}
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">${car.plateNumber}</h3>
                                <p class="text-gray-600">${car.ownerName}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editCar(${car.id})" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                                    </svg>
                                </button>
                                <button onclick="deleteCar(${car.id})" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div class="space-y-2 mb-4">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">×˜×œ×¤×•×Ÿ:</span>
                                <span class="font-semibold">${car.phone || '-'}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">×¡×•×’:</span>
                                <span class="font-semibold">${car.carType || '-'}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">×“×’×:</span>
                                <span class="font-semibold">${car.model || '-'}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">×©× ×”:</span>
                                <span class="font-semibold">${car.year || '-'}</span>
                            </div>
                            ${car.engineType ? `
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">×× ×•×¢:</span>
                                    <span class="font-semibold">${car.engineType}</span>
                                </div>
                            ` : ''}
                            ${car.enginePower ? `
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">×”×¡×¤×§:</span>
                                    <span class="font-semibold">${car.enginePower}</span>
                                </div>
                            ` : ''}
                        </div>

                        <div class="border-t pt-4">
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-sm text-gray-600">×˜×™×¤×•×œ×™×:</span>
                                <span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-sm font-bold">
                                    ${car.maintenanceHistory?.length || 0}
                                </span>
                            </div>
                            <button onclick="showCarDetails(${car.id})" class="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white py-2 rounded-lg hover:from-blue-700 hover:to-blue-800 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                    <polyline points="10 9 9 9 8 9"></polyline>
                                </svg>
                                ×”×¦×’ ×¤×¨×˜×™×
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Filter cars
        function filterCars() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const selectedType = document.getElementById('carTypeFilter').value;
            const cards = document.querySelectorAll('.car-card');
            
            let visibleCount = 0;
            
            cards.forEach(card => {
                const plate = card.dataset.plate.toLowerCase();
                const owner = card.dataset.owner.toLowerCase();
                const carType = card.dataset.cartype || '';
                
                const matchesSearch = plate.includes(searchTerm) || owner.includes(searchTerm);
                const matchesType = !selectedType || carType === selectedType;
                
                if (matchesSearch && matchesType) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            document.getElementById('carCount').textContent = visibleCount;
        }

        // Show add car form
        function showAddCarForm() {
            editingCarId = null;
            tempCarImage = null;
            document.getElementById('carModalTitle').textContent = '×”×•×¡×¤×ª ×¨×›×‘ ×—×“×©';
            document.getElementById('plateNumber').value = '';
            document.getElementById('ownerName').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('carType').value = '';
            document.getElementById('model').value = '';
            document.getElementById('year').value = '';
            document.getElementById('carCode').value = '';
            document.getElementById('engineType').value = '';
            document.getElementById('enginePower').value = '';
            displayCarImagePreview();
            populateCarTypeSuggestions();
            document.getElementById('carModal').classList.remove('hidden');
        }

        // Edit car
        function editCar(carId) {
            const car = cars.find(c => c.id === carId);
            if (!car) return;
            
            editingCarId = carId;
            tempCarImage = car.image || null;
            document.getElementById('carModalTitle').textContent = '×¢×¨×™×›×ª ×¨×›×‘';
            document.getElementById('plateNumber').value = car.plateNumber;
            document.getElementById('ownerName').value = car.ownerName;
            document.getElementById('phone').value = car.phone || '';
            document.getElementById('carType').value = car.carType || '';
            document.getElementById('model').value = car.model || '';
            document.getElementById('year').value = car.year || '';
            document.getElementById('carCode').value = car.carCode || '';
            document.getElementById('engineType').value = car.engineType || '';
            document.getElementById('enginePower').value = car.enginePower || '';
            displayCarImagePreview();
            populateCarTypeSuggestions();
            handleCarTypeChange();
            document.getElementById('carModal').classList.remove('hidden');
        }

        // Save car
        function saveCar() {
            const plateNumber = document.getElementById('plateNumber').value.trim();
            const ownerName = document.getElementById('ownerName').value.trim();
            
            if (!plateNumber || !ownerName) {
                alert('× × ×œ×”×–×™×Ÿ ××¡×¤×¨ ×¨×™×©×•×™ ×•×©× ×”×‘×¢×œ×™×');
                return;
            }
            
            const carData = {
                plateNumber,
                ownerName,
                phone: document.getElementById('phone').value.trim(),
                carType: document.getElementById('carType').value.trim(),
                model: document.getElementById('model').value.trim(),
                year: document.getElementById('year').value.trim(),
                carCode: document.getElementById('carCode').value.trim(),
                engineType: document.getElementById('engineType').value.trim(),
                enginePower: document.getElementById('enginePower').value.trim(),
                image: tempCarImage
            };
            
            if (editingCarId) {
                const index = cars.findIndex(c => c.id === editingCarId);
                cars[index] = { ...cars[index], ...carData };
            } else {
                cars.push({
                    id: Date.now(),
                    ...carData,
                    maintenanceHistory: []
                });
            }
            
            saveData();
            renderCars();
            updateCarTypeFilter();
            closeCarModal();
        }

        // Close car modal
        function closeCarModal() {
            document.getElementById('carModal').classList.add('hidden');
            editingCarId = null;
            tempCarImage = null;
        }

        // Delete car
        function deleteCar(carId) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×¨×›×‘ ×–×”?')) return;
            
            cars = cars.filter(c => c.id !== carId);
            saveData();
            updateCarTypeFilter();
            renderCars();
        }

        // Show car details
        function showCarDetails(carId) {
            const car = cars.find(c => c.id === carId);
            if (!car) return;
            
            selectedCarId = carId;
            document.getElementById('detailsPlate').textContent = car.plateNumber;
            document.getElementById('detailsOwner').textContent = car.ownerName;
            
            const carImageDiv = document.getElementById('detailsCarImage');
            if (car.image) {
                carImageDiv.innerHTML = `
                    <img src="${car.image}" alt="${car.plateNumber}" class="w-full h-64 object-cover rounded-xl cursor-pointer" onclick="viewImage('${car.image}')">
                `;
            } else {
                carImageDiv.innerHTML = '';
            }
            
            document.getElementById('detailsInfo').innerHTML = `
                <div style="grid-column: span 3;">
                    <p class="text-gray-600 text-sm mb-2">×©×œ×— ×”×•×“×¢×ª ×•×•××˜×¡××¤ ××”×™×¨×”</p>
                    <div class="flex gap-2 flex-wrap">
                        ${car.phone ? `
                            <a href="https://wa.me/${formatPhoneForWhatsApp(car.phone)}?text=${encodeURIComponent('×©×œ×•× ' + car.ownerName + ', ×¨×›×‘×š ' + car.plateNumber + ' × ×›× ×¡ ×œ×˜×™×¤×•×œ ×‘××•×¡×š. × ×¢×“×›×Ÿ ××•×ª×š ×‘×”××©×š.')}" target="_blank" class="flex items-center gap-1 bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 transition text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                                </svg>
                                × ×›× ×¡ ×œ×˜×™×¤×•×œ
                            </a>
                            <a href="https://wa.me/${formatPhoneForWhatsApp(car.phone)}?text=${encodeURIComponent('×©×œ×•× ' + car.ownerName + ', ×¨×›×‘×š ' + car.plateNumber + ' ××•×›×Ÿ ×•××—×›×” ×œ××™×¡×•×£. × ×™×ª×Ÿ ×œ×‘×•× ×œ×§×—×ª ××ª ×”×¨×›×‘.')}" target="_blank" class="flex items-center gap-1 bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 transition text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                                </svg>
                                ××•×›×Ÿ ×œ××™×¡×•×£
                            </a>
                            <a href="https://wa.me/${formatPhoneForWhatsApp(car.phone)}?text=${encodeURIComponent('×©×œ×•× ' + car.ownerName + ', ×¨×›×‘×š ' + car.plateNumber + ' × ××¡×¨ ×‘×”×¦×œ×—×”. ×ª×•×“×” ×©×‘×—×¨×ª ×‘×©×™×¨×•×ª×™× ×•!')}" target="_blank" class="flex items-center gap-1 bg-purple-500 text-white px-3 py-2 rounded-lg hover:bg-purple-600 transition text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                                </svg>
                                × ××¡×¨
                            </a>
                        ` : '<span class="text-gray-500 text-sm">××™×Ÿ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ</span>'}
                    </div>
                </div>
                <div>
                    <p class="text-gray-600 text-sm">×˜×œ×¤×•×Ÿ</p>
                    <p class="font-semibold">${car.phone || '-'}</p>
                </div>
                <div>
                    <p class="text-gray-600 text-sm">×¡×•×’ ×¨×›×‘</p>
                    <p class="font-semibold">${car.carType || '-'}</p>
                </div>
                <div>
                    <p class="text-gray-600 text-sm">×“×’×</p>
                    <p class="font-semibold">${car.model || '-'}</p>
                </div>
                <div>
                    <p class="text-gray-600 text-sm">×©× ×”</p>
                    <p class="font-semibold">${car.year || '-'}</p>
                </div>
                ${car.carCode ? `
                    <div>
                        <p class="text-gray-600 text-sm">×§×•×“ ×¨×›×‘ (VIN)</p>
                        <p class="font-semibold text-xs">${car.carCode}</p>
                    </div>
                ` : ''}
                ${car.engineType ? `
                    <div>
                        <p class="text-gray-600 text-sm">×¡×•×’ ×× ×•×¢</p>
                        <p class="font-semibold">${car.engineType}</p>
                    </div>
                ` : ''}
                ${car.enginePower ? `
                    <div>
                        <p class="text-gray-600 text-sm">×”×¡×¤×§ ×× ×•×¢</p>
                        <p class="font-semibold">${car.enginePower}</p>
                    </div>
                ` : ''}
            `;
            
            renderMaintenanceList(car);
            document.getElementById('detailsModal').classList.remove('hidden');
        }

        // Render maintenance list
        function renderMaintenanceList(car) {
            const list = document.getElementById('maintenanceList');
            
            if (!car.maintenanceHistory || car.maintenanceHistory.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-12 bg-gray-50 rounded-xl">
                        <svg class="mx-auto text-gray-400 mb-4" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                        </svg>
                        <p class="text-gray-600">××™×Ÿ ×˜×™×¤×•×œ×™× ×¨×©×•××™× ×¢×“×™×™×Ÿ</p>
                    </div>
                `;
                return;
            }
            
            const sorted = [...car.maintenanceHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            list.innerHTML = sorted.map(m => `
                <div class="border-2 border-gray-200 rounded-xl p-6 hover:border-blue-300 transition mb-4">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600">
                                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                            </svg>
                            <div>
                                <h4 class="text-xl font-bold text-gray-800">${m.partName}</h4>
                                <p class="text-gray-600 text-sm">${new Date(m.date).toLocaleDateString('he-IL')}</p>
                                ${m.kilometers ? `<p class="text-blue-600 text-sm font-semibold">ğŸ“ ${Number(m.kilometers).toLocaleString()} ×§"×</p>` : ''}
                            </div>
                        </div>
                        <div class="text-left flex items-start gap-2">
                            <div>
                                <p class="text-2xl font-bold text-green-600">${m.cost} â‚ª</p>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="printMaintenance(${m.id})" class="p-1.5 text-purple-600 hover:bg-purple-50 rounded-lg transition" title="×”×“×¤×¡ ×˜×™×¤×•×œ">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="6 9 6 2 18 2 18 9"></polyline>
                                        <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                                        <rect x="6" y="14" width="12" height="8"></rect>
                                    </svg>
                                </button>
                                <button onclick="editMaintenance(${m.id})" class="p-1.5 text-blue-600 hover:bg-blue-50 rounded-lg transition" title="×¢×¨×•×š ×˜×™×¤×•×œ">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                                    </svg>
                                </button>
                                <button onclick="deleteMaintenance(${m.id})" class="p-1.5 text-red-600 hover:bg-red-50 rounded-lg transition" title="××—×§ ×˜×™×¤×•×œ">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    ${m.description ? `<p class="text-gray-700 bg-gray-50 p-3 rounded-lg mb-3">${m.description}</p>` : ''}
                    ${m.images && m.images.length > 0 ? `
                        <div class="mt-4">
                            <p class="text-sm font-semibold text-gray-700 mb-2">×ª××•× ×•×ª ×”×ª×§×œ×”:</p>
                            <div class="grid grid-cols-4 gap-2">
                                ${m.images.map(img => `
                                    <img src="${img}" alt="Maintenance" class="w-full h-20 object-cover rounded-lg cursor-pointer hover:opacity-80 transition" onclick="viewImage('${img}')">
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // Close details modal
        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.add('hidden');
            selectedCarId = null;
        }

        // Show maintenance form
        function showMaintenanceForm() {
            editingMaintenanceId = null;
            tempMaintenanceImages = [];
            document.getElementById('maintenanceModalTitle').textContent = '×”×•×¡×¤×ª ×˜×™×¤×•×œ';
            document.getElementById('saveMaintenanceBtn').textContent = '×”×•×¡×£ ×˜×™×¤×•×œ';
            document.getElementById('maintenanceDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('kilometers').value = '';
            document.getElementById('partName').value = '';
            document.getElementById('description').value = '';
            document.getElementById('cost').value = '';
            displayMaintenanceImagesPreview();
            document.getElementById('maintenanceModal').classList.remove('hidden');
        }

        // Edit maintenance
        function editMaintenance(maintenanceId) {
            const car = cars.find(c => c.id === selectedCarId);
            const maintenance = car.maintenanceHistory.find(m => m.id === maintenanceId);
            if (!maintenance) return;
            
            editingMaintenanceId = maintenanceId;
            tempMaintenanceImages = maintenance.images ? [...maintenance.images] : [];
            
            document.getElementById('maintenanceModalTitle').textContent = '×¢×¨×™×›×ª ×˜×™×¤×•×œ';
            document.getElementById('saveMaintenanceBtn').textContent = '×¢×“×›×Ÿ ×˜×™×¤×•×œ';
            document.getElementById('maintenanceDate').value = maintenance.date;
            document.getElementById('kilometers').value = maintenance.kilometers || '';
            document.getElementById('partName').value = maintenance.partName;
            document.getElementById('description').value = maintenance.description || '';
            document.getElementById('cost').value = maintenance.cost;
            displayMaintenanceImagesPreview();
            document.getElementById('maintenanceModal').classList.remove('hidden');
        }

        // Delete maintenance
        function deleteMaintenance(maintenanceId) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×˜×™×¤×•×œ ×–×”?')) return;
            
            const carIndex = cars.findIndex(c => c.id === selectedCarId);
            cars[carIndex].maintenanceHistory = cars[carIndex].maintenanceHistory.filter(m => m.id !== maintenanceId);
            
            saveData();
            renderMaintenanceList(cars[carIndex]);
            renderCars();
        }

        // Print maintenance
        function printMaintenance(maintenanceId) {
            const car = cars.find(c => c.id === selectedCarId);
            const maintenance = car.maintenanceHistory.find(m => m.id === maintenanceId);
            if (!maintenance) return;
            
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html dir="rtl" lang="he">
                <head>
                    <meta charset="UTF-8">
                    <title>×“×•×— ×˜×™×¤×•×œ - ${car.plateNumber}</title>
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                            font-family: Arial, sans-serif;
                        }
                        @page {
                            size: A4;
                            margin: 20mm;
                        }
                        body {
                            padding: 30px;
                            background: white;
                            max-width: 210mm;
                            margin: 0 auto;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 3px solid #2563eb;
                            padding-bottom: 15px;
                            margin-bottom: 25px;
                        }
                        .header h1 {
                            color: #2563eb;
                            font-size: 28px;
                            margin-bottom: 8px;
                        }
                        .header p {
                            color: #6b7280;
                            font-size: 14px;
                        }
                        .section {
                            margin-bottom: 20px;
                            background: #f9fafb;
                            padding: 15px;
                            border-radius: 8px;
                            border-right: 4px solid #2563eb;
                        }
                        .section-title {
                            font-size: 18px;
                            font-weight: bold;
                            color: #1f2937;
                            margin-bottom: 12px;
                        }
                        .info-grid {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 12px;
                        }
                        .info-item {
                            display: flex;
                            flex-direction: column;
                        }
                        .info-label {
                            font-size: 13px;
                            color: #6b7280;
                            margin-bottom: 4px;
                        }
                        .info-value {
                            font-size: 16px;
                            font-weight: bold;
                            color: #1f2937;
                        }
                        .description {
                            background: white;
                            padding: 12px;
                            border-radius: 8px;
                            color: #374151;
                            line-height: 1.5;
                            font-size: 14px;
                        }
                        .cost-box {
                            background: #10b981;
                            color: white;
                            padding: 18px;
                            border-radius: 8px;
                            text-align: center;
                            margin-top: 20px;
                        }
                        .cost-box .label {
                            font-size: 15px;
                            margin-bottom: 8px;
                        }
                        .cost-box .value {
                            font-size: 32px;
                            font-weight: bold;
                        }
                        .footer {
                            margin-top: 30px;
                            text-align: center;
                            color: #9ca3af;
                            font-size: 12px;
                            border-top: 2px solid #e5e7eb;
                            padding-top: 15px;
                        }
                        @media print {
                            body {
                                padding: 15px;
                            }
                            .header h1 {
                                font-size: 24px;
                            }
                            .section {
                                page-break-inside: avoid;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>ğŸ”§ ×“×•×— ×˜×™×¤×•×œ</h1>
                        <p>××¢×¨×›×ª × ×™×”×•×œ ××•×¡×š</p>
                    </div>

                    <div class="section">
                        <div class="section-title">×¤×¨×˜×™ ×¨×›×‘</div>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">××¡×¤×¨ ×¨×™×©×•×™</span>
                                <span class="info-value">${car.plateNumber}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">×©× ×”×‘×¢×œ×™×</span>
                                <span class="info-value">${car.ownerName}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">×˜×œ×¤×•×Ÿ</span>
                                <span class="info-value">${car.phone || '-'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">×¡×•×’ ×¨×›×‘</span>
                                <span class="info-value">${car.carType || '-'} ${car.model || ''}</span>
                            </div>
                            ${car.carCode ? `
                                <div class="info-item" style="grid-column: span 2;">
                                    <span class="info-label">×§×•×“ ×¨×›×‘ (VIN)</span>
                                    <span class="info-value" style="font-size: 14px;">${car.carCode}</span>
                                </div>
                            ` : ''}
                            ${car.engineType ? `
                                <div class="info-item">
                                    <span class="info-label">×¡×•×’ ×× ×•×¢</span>
                                    <span class="info-value">${car.engineType}</span>
                                </div>
                            ` : ''}
                            ${car.enginePower ? `
                                <div class="info-item">
                                    <span class="info-label">×”×¡×¤×§ ×× ×•×¢</span>
                                    <span class="info-value">${car.enginePower}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">×¤×¨×˜×™ ×˜×™×¤×•×œ</div>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">×ª××¨×™×š</span>
                                <span class="info-value">${new Date(maintenance.date).toLocaleDateString('he-IL')}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">×§×™×œ×•××˜×¨××–'</span>
                                <span class="info-value">${maintenance.kilometers ? Number(maintenance.kilometers).toLocaleString() + ' ×§"×' : '-'}</span>
                            </div>
                            <div class="info-item" style="grid-column: span 2;">
                                <span class="info-label">×—×œ×§ ×©×”×•×—×œ×£</span>
                                <span class="info-value">${maintenance.partName}</span>
                            </div>
                        </div>
                        ${maintenance.description ? `
                            <div style="margin-top: 15px;">
                                <span class="info-label">×ª×™××•×¨ ×”×¢×‘×•×“×”</span>
                                <div class="description">${maintenance.description}</div>
                            </div>
                        ` : ''}
                    </div>

                    <div class="cost-box">
                        <div class="label">×¡×š ×”×›×œ ×œ×ª×©×œ×•×</div>
                        <div class="value">${maintenance.cost} â‚ª</div>
                    </div>

                    <div class="footer">
                        <p>×ª××¨×™×š ×”×“×¤×¡×”: ${new Date().toLocaleDateString('he-IL')} | ××¢×¨×›×ª × ×™×”×•×œ ××•×¡×š</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }

        // Save maintenance
        function saveMaintenance() {
            const partName = document.getElementById('partName').value.trim();
            const cost = document.getElementById('cost').value.trim();
            const kilometers = document.getElementById('kilometers').value.trim();
            
            if (!partName || !cost || !kilometers) {
                alert('× × ×œ×”×–×™×Ÿ ×©× ×”×—×œ×§, ×¢×œ×•×ª ×•×§×™×œ×•××˜×¨××–\'');
                return;
            }
            
            const maintenanceData = {
                date: document.getElementById('maintenanceDate').value,
                kilometers,
                partName,
                description: document.getElementById('description').value.trim(),
                cost,
                images: [...tempMaintenanceImages]
            };
            
            const carIndex = cars.findIndex(c => c.id === selectedCarId);
            if (!cars[carIndex].maintenanceHistory) {
                cars[carIndex].maintenanceHistory = [];
            }
            
            if (editingMaintenanceId) {
                const maintenanceIndex = cars[carIndex].maintenanceHistory.findIndex(m => m.id === editingMaintenanceId);
                cars[carIndex].maintenanceHistory[maintenanceIndex] = {
                    ...cars[carIndex].maintenanceHistory[maintenanceIndex],
                    ...maintenanceData
                };
            } else {
                cars[carIndex].maintenanceHistory.push({
                    id: Date.now(),
                    ...maintenanceData
                });
            }
            
            saveData();
            renderMaintenanceList(cars[carIndex]);
            renderCars();
            closeMaintenanceModal();
        }

        // Close maintenance modal
        function closeMaintenanceModal() {
            document.getElementById('maintenanceModal').classList.add('hidden');
            editingMaintenanceId = null;
            tempMaintenanceImages = [];
        }

        // Export to Excel
        function exportToExcel() {
            let csvContent = "\uFEFF××¡×¤×¨ ×¨×™×©×•×™,×©× ×”×‘×¢×œ×™×,××¡×¤×¨ ×˜×œ×¤×•×Ÿ,×¡×•×’ ×¨×›×‘,×“×’×,×©× ×ª ×™×™×¦×•×¨\n";
            
            cars.forEach(car => {
                csvContent += `${car.plateNumber},${car.ownerName},${car.phone || ''},${car.carType || ''},${car.model || ''},${car.year || ''}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'garage_data.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Initialize
        loadData();
    </script>
</body>
</html>
